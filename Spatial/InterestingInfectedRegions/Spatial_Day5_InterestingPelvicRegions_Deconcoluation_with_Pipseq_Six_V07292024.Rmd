---
title: "Spatial_InterestingInfectedRegions_Deconcoluation_with_Pipseq_Six_V1012"
output: html_document
Author: Xin Wang
Email: xin.wang@nationwidechildrens.org 
Copyright (c) 2023 Kidney and Urology Tract Center
Nationwide Children's Hospital
date: "2024-07-29"
Description: 
#   The script is to profile the interesting infected Abscess regions including D1 that have the neutrophil activation

#     Note:
#    #     We have already got the deconvolution of the spatial transcriptomics
#    #     We will concentrate on the Abscess neighbourhood

#     Function:
#           1). Generate overall features of these abscess regions 
#           2).  Generate the deconvoluted cell types of these abscess regions 
#           3). Generate the biomarkers and DEGs of these abscess regions
#           4). Generate the GO enrichments of these abscess regions
#           5). Generate the Signaling of these abscess regions
#           6). Generate the transcript factor of these abacess regions
#           7). Generate the niche-niche communication
#           8). 

#     Reference: https://nbisweden.github.io/workshop-scRNAseq/labs/compiled/seurat/seurat_07_spatial.html
---

# load the library packages
```{r}
# loading the library packages
library(Seurat)
#library(SeuratData)
library(ggplot2)
library(patchwork)
library(dplyr)
library(Matrix)
library(tidyverse)
library(SeuratObject)
#install.packages("harmony")
library(harmony)
library(SPOTlight)
#library(scater)
#library(scran)
library(SingleCellExperiment)

#install.packages("SeuratDisk")
#library(SeuratDisk)
library(tidyverse)
library(cowplot)

library(ggplot2)
library(reshape2)
library(Hmisc)
library(stats)
library(corrplot)
library(RColorBrewer)
## Deconvolve
#install.packages("L1pack")
#install.packages("reshape")
library(L1pack)
library(reshape)
library(reshape2)

library(SPOTlight)
library(tidyHeatmap)
library(ComplexHeatmap)
library(ComplexHeatmap)

library(RColorBrewer)
library(circlize)
library(monocle3)
#install.packages("magick")
library(magick)
library(progeny)
library(pheatmap)
library(clusterProfiler)
library(decoupleR)

# install SPATA
BiocManager::install(c('BiocGenerics', 'DelayedArray', 'DelayedMatrixStats',
                       'limma', 'S4Vectors', 'SingleCellExperiment',
                       'SummarizedExperiment', 'batchelor', 'Matrix.utils', 'EBImage'))

#install.packages("Seurat")

devtools::install_github(repo = "kueckelj/confuns")
devtools::install_github(repo = "theMILOlab/SPATAData")
devtools::install_github(repo = "theMILOlab/SPATA2")

library(SPATA2)
library(SPATAData)
library(tidyverse)


```

# Set up the enviroment: 
```{r}
# clear all the objects in the environments
#rm(list=ls())
# set seed
set.seed(200000)

# single cell directory:
#Scindir = "/Users/XXW004/Documents/Projects/RuizRosado/PIPseq/Results/Evaluation_V022723/CellEvaluation_Subclustering_V0803/Immune_Subclusters/OutputRDS/"

# spatial transcript directory that contain the deconvoluted file 
Spindir ="/Users/XXW004/Documents/Projects/RuizRosado/SpatialTranscriptomic/Results/Deconvolution_Six_V07292024/"

# Output directory :
Outdir = "/Users/XXW004/Documents/Projects/RuizRosado/SpatialTranscriptomic/Results/NichesDEGs_V07292024/InfectedCortexMedD5Pelvic/"

# Cell types deconvolution:

CDecodir = "/Users/XXW004/Documents/Projects/RuizRosado/SpatialTranscriptomic/Results/NichesDEGs_V07292024/InfectedCortexMedD5Pelvic/Deconvolution/"

# BasicSpatialDim

CAbdir = "/Users/XXW004/Documents/Projects/RuizRosado/SpatialTranscriptomic/Results/NichesDEGs_V07292024/InfectedCortexMedD5Pelvic/BasicSpatialDim/"

# Biomarkers
CBiomadir ="/Users/XXW004/Documents/Projects/RuizRosado/SpatialTranscriptomic/Results/NichesDEGs_V07292024/InfectedCortexMedD5Pelvic/CellTypesBiomarkers/"


CDEGdir = "/Users/XXW004/Documents/Projects/RuizRosado/SpatialTranscriptomic/Results/NichesDEGs_V07292024/InfectedCortexMedD5Pelvic/DEGs/"

# GOEnrichment

CGOEndir = "/Users/XXW004/Documents/Projects/RuizRosado/SpatialTranscriptomic/Results/NichesDEGs_V07292024/InfectedCortexMedD5Pelvic/GOenrich/"

# Progeny
CProgenydir = "/Users/XXW004/Documents/Projects/RuizRosado/SpatialTranscriptomic/Results/NichesDEGs_V07292024/InfectedCortexMedD5Pelvic/Progeny/"

# Transcript factor
CTFdir = "/Users/XXW004/Documents/Projects/RuizRosado/SpatialTranscriptomic/Results/NichesDEGs_V07292024/InfectedCortexMedD5Pelvic/TranscriptFactors/"

# Niche niche Communication

CNichComdir = "/Users/XXW004/Documents/Projects/RuizRosado/SpatialTranscriptomic/Results/NichesDEGs_V07292024/InfectedCortexMedD5Pelvic/NicheCommunicate/"

# Concentrate on the infection area abscess from CorMed

InfCorMeddir ="/Users/XXW004/Documents/Projects/RuizRosado/SpatialTranscriptomic/Results/NichesDEGs_V07292024/InfectedCortexMedD5Pelvic/"

# nichenet path

data_path = "/Users/XXW004/Documents/Projects/LectureForSingleCellGroup/Datasets/NicheNet/"


dir.create(CDecodir, showWarnings = F)
dir.create(CAbdir, showWarnings = F)
dir.create(CBiomadir, showWarnings = F)
dir.create(CGOEndir, showWarnings = F)
dir.create(CProgenydir, showWarnings = F)
dir.create(CTFdir, showWarnings = F)
dir.create(CNichComdir, showWarnings = F)
#dir.create(Day7dir, showWarnings = F)
dir.create(InfCorMeddir, showWarnings = F)
#dir.create(InfCorMeddir, showWarnings = F)
dir.create(CDEGdir, showWarnings = F)


getwd()
setwd(InfCorMeddir)
InfCorMeddir
```

<!-- # Read the RDS objects from the spatial and single cells, briefly check the objects -->
<!-- ```{r} -->
<!-- # Reading the RDS file -->
<!-- Pyelonephritis_Infection<-readRDS(file = paste0(Spindir, "PreliminaryIntegratedSpatialHarmorny_Pyelonephritis_onlySlide_QC_v0906.RDS")) -->

<!-- #  -->
<!-- Pyelonephritis_Infection -->

<!-- SpatialDimPlot(Pyelonephritis_Infection) -->
<!-- # We have two assays: Spatial and SCT -->
<!-- Pyelonephritis_Infection[["Spatial"]][1:10,1:10] -->

<!-- Pyelonephritis_Infection[["SCT"]][1:10,1:10] -->

<!-- rownames(Pyelonephritis_Infection[["Spatial"]]) -->
<!-- colnames(Pyelonephritis_Infection[["Spatial"]]) -->
<!-- selectedslices<- c("slice1","slice7","slice4","slice7","slice8","slice9") -->
<!-- Idents(Pyelonephritis_Infection) -->

<!-- DimPlot(Pyelonephritis_Infection) -->
<!-- ``` -->

# read the deconvoluted object into Pyelonephritis_Infection_Deconvoluted.RDS
```{r}
#saveRDS(file = "Pyelonephritis_Infection_Deconvoluted.RDS", object = Pyelonephritis_Infection)

Pyelonephritis_Infection <- readRDS(file = paste0(Spindir,"Pyelonephritis_Infection_Deconvoluted_v07292024.RDS"))
Allimagmes= names(Pyelonephritis_Infection @images)

# Briefly went through all the details
# 
Pyelonephritis_Infection

SpatialDimPlot(Pyelonephritis_Infection, pt.size.factor = 1500)
# We have four assays: Spatial,integrated, prediction, and SCT
Pyelonephritis_Infection[["Spatial"]]

Pyelonephritis_Infection[["SCT"]]@data
Pyelonephritis_Infection[["predictions"]]
rownames(Pyelonephritis_Infection[["Spatial"]])
colnames(Pyelonephritis_Infection[["Spatial"]])
selectedslices<- c("slice1","slice3","slice4","slice7","slice8","slice9")
Idents(Pyelonephritis_Infection)

DimPlot(Pyelonephritis_Infection)

```
# ############################## 
# only concentrate on the specific infected regions with neutrophil and macro at day 5
# Cortex and Medulla region
# ############################## 
```{r}
setwd(CAbdir)

DefaultAssay(Pyelonephritis_Infection) <-"Spatial"
# we only select the Day 5
Pyelonephritis_Infection$orig.ident
Pyelonephritis_InfectionSubslidesD5 <-
    subset (Pyelonephritis_Infection, orig.ident == "PyeloD5_2")
#names(Pyelonephritis_InfectionSubslidesD5@images)
  # there seems to be an error in the susetting, so we removed other igmages
  #names(Pyelonephritis_InfectionSubslides@images)
SelectedImageName <- names(Pyelonephritis_InfectionSubslidesD5@images)
SelectedImageName
OtherImages <- Allimagmes[Allimagmes != SelectedImageName]
OtherImages
Pyelonephritis_InfectionSubslidesD5@images[OtherImages] = NULL
Pyelonephritis_InfectionSubslidesD5@meta.data %>% head()
# for a specific regions and specific clusters
# get the coordate of these cluster
coords <- GetTissueCoordinates(Pyelonephritis_InfectionSubslidesD5)
coords %>% head()
Pyelonephritis_InfectionSubslidesD5@meta.data %>% head()
summary(coords)
Pyelonephritis_InfectionSubslidesD5@images$slice7

SpatialDimPlot(Pyelonephritis_InfectionSubslidesD5,pt.size.factor = 1500)
#DefaultAssay(Pyelonephritis_InfectionSubslidesD5) <-"Spatial"
# we then select the regions for the cluster : , invert = TRUE
D5Pevsubcluster <- subset (Pyelonephritis_InfectionSubslidesD5, slice7_imagerow > 250 &slice7_imagerow < 350 & slice7_imagecol >235  &slice7_imagecol <280)
SpatialDimPlot(D5Pevsubcluster, pt.size.factor = 1500)
D5Pevsubcluster <- subset (D5Pevsubcluster, idents = c("N7","N8","N10","N11","N12"))
InfectedCorMedRegionD5Spatial <-SpatialDimPlot(D5Pevsubcluster,label = TRUE, pt.size.factor = 1500)
?SpatialDimPlot
InfectedCorMedRegionD5Spatial
ggsave("Spatial_infectedPelivis_day5_SpatialDimplot.pdf",
      plot = InfectedCorMedRegionD5Spatial,
      height = 3,
      width = 4 )

InfectedCorMedRegionD5SpatialDim<- DimPlot(D5Pevsubcluster,label = TRUE)
ggsave("Spatial_infectedPelivis_day5_Dimplot.pdf",
      plot = InfectedCorMedRegionD5SpatialDim,
      height = 3,
      width = 4 )
InfectedCorMedRegionD5SpatialDim
# define the cell type order
# set up the order 
CelltypeOrder <- c("PT-S1S2-1","PT-S1S2-2","PT-S3-1","PT-S3-2", "PT-S1S2-N1",  "PT-S1S2-N2","PT-S1S2-N3","InfPT","ProfPT","PC1","PC2","ICA" ,"ICB", "DegCD", "DTL", "TAL","DCT-TAL"  ,"CNT","SMC" ,"URO", "DegURO","FIB" , "END","PL",  "ResMac" , "MONa","MONb", "MACa", "MACb", "NEU"  ,"T" ,"B","NK" )


 ordered((rownames(D5Pevsubcluster[["predictions"]]@data)),levels =CelltypeOrder)
 
# get the summary of the selected regions
 GetTissueCoordinates(D5Pevsubcluster)
 summary(GetTissueCoordinates(D5Pevsubcluster))
```
# ############################## 
# Generate the deconvoluted details
# ############################## 
```{r}
setwd(CDecodir)
# the prediction of the object
D5Pevsubcluster[["predictions"]]
InfectedMat_Pev<- t(D5Pevsubcluster[["predictions"]]@data)
colnames(InfectedMat_Pev) <- ordered (colnames(InfectedMat_Pev), levels =CelltypeOrder)

# change the order
InfectedMat_Pev<- InfectedMat_Pev[ ,CelltypeOrder]
# for final celltype matrix: 
InfectedMat_PevCellType<- InfectedMat_Pev[,!colnames(InfectedMat_Pev) %in% c("max")]
InfectedMat_PevCellTypeNozero <- InfectedMat_PevCellType[,colSums(InfectedMat_PevCellType)>0]


# correlation
InfectedMat_PevCellTypeCorrelationMatrix<-plotCorrelationMatrix(InfectedMat_PevCellTypeNozero)
InfectedMat_PevCellTypeCorrelationMatrix
InfectedMat_PevCellTypeInteractions<- plotInteractions(InfectedMat_PevCellTypeNozero, "heatmap") + scale_fill_gradientn(colors = c("blue", "white", "red"))

ggsave("SpatialScatterPieInfectedCorMed_CorrelationMatrix.pdf", plot =InfectedMat_PevCellTypeCorrelationMatrix, height = 6, width = 6 )

ggsave("SpatialScatterPieInfectedCorMed_HeatmapColocalization.pdf", plot =InfectedMat_PevCellTypeInteractions, height = 6, width = 6 )
# scatterpie plot
# scatterpie plot
# 
ct <- colnames(InfectedMat_PevCellType)
ct
# we did not add the low proportion in the scatterpie, we here also consider the low 
#InfectedMat_PevCellType[InfectedMat_PevCellType < 0.1] <- 0

  paletteMartin <- c( 
    "#b6dbff", # PT-S1S2-N1
    "#99CCFF", # PT-S1S2-N2
    "#0099FF", # PT-S3-1
    "#6699FF", # PT-S3-2
    "#006ddb", # PT-S1S2-N1
    "#EE4E34", # PT-S1S2-N2
    "#66CC99", # PT-S1S2-N3
    "#F5DEB3", # InfPT
    "#A8554E", # ProfPT
    "#ff6db6", #PC1
    "#FF6666", #PC2
    "#CCF381", #ICA
    "#CCF101", #ICB
    "#BEE5BF", #DegCD
    "#33FFFF", # DTL
    "#b66dff", #TAL
    "#FF9900", #DCT-TAL
    "#FFD700", # CNT
    "#ADE700", # SMC
    "#C5DECD", #URO
    "#66Ff66", #DegURO
    "#9999CC", #FIB
    "#FF0099", #END
    "#8ad8e8", #PL
    "#F3ED87",#ResMAC
    "#F6874F",#MONa
    "#F3AB87",#MONb
    "#FFFF00",#MACa
    "#EFEB15",#MACb
    "black", #NEU
    "#ebece5",# T
   "#f47a22",# B 
   "#9b59b6"#NK 
  )

#DefaultAssay(Pyelonephritis_InfectionSubslidesD5) <- "Spatial"

# choose three color
# pal<-colorRampPalette(c("LightBlue","white","FireBrick"))(length(ct))
# choose the selected color
pal <- colorRampPalette(paletteMartin)(length(ct))

# choose the spectral range colors:
# https://earlglynn.github.io/RNotes/package/RColorBrewer/index.html
#pal <- (colorRampPalette(brewer.pal(11,"Paired"))(length(ct)))

names(pal) <- ct
#pal
rownames(D5Pevsubcluster)
colnames(D5Pevsubcluster)
str(D5Pevsubcluster)
#SPOTlight:::. extract_image(Pyelonephritis_Infection )
#rownames(Pyelonephritis_Infection)
SpatialScatterPieCorMed <-plotSpatialScatterpie(
  x= D5Pevsubcluster,
  y= InfectedMat_PevCellType,
  cell_types = colnames(InfectedMat_PevCellType),
    img = TRUE,
    scatterpie_alpha = 1,
    pie_scale = 1.6) +
    scale_fill_manual(
        values = pal,
        breaks = names(pal)) +coord_sf(xlim = c(230, 280), ylim = c(150, 250))

SpatialScatterPieCorMed
# slice7_imagerow > 200 &slice7_imagerow < 300 & slice7_imagecol >280  &slice7_imagecol <400

ggsave("SpatialScatterPieCorMed.pdf",plot = SpatialScatterPieCorMed, height = 3,width = 4.5)
# colnames(DeconvolutedMatrix)
# ncol(Pyelonephritis_Infection)
# nrow(DeconvolutedMatrix)
InfectedMat_PevCellType
pdf(file = "SpatialScatterPieCorMed_CellTypeNetwork.pdf", height = 8,width = 8)
plotInteractions(InfectedMat_PevCellType, "network")
dev.off()

```




# ############################## 
# Generate the biomarkers within timepoints
# ############################## 
```{r}
CBiomadir
setwd(CBiomadir)
# generate the Dotplot for the biomarkers
DefaultAssay(D5Pevsubcluster) <-"SCT"
Finalcelltypemarkers<- c("Lrp2","Slc34a1","Slc13a3", # Proximal tubule cells (PT)
                      "Slc12a3","Pvalb","Wnk1",# Distal connecting tublue (DCT)

                     "Umod","Slc12a1","Cldn10", # Thick ascending limb cells (TAL)
                      "Klk1","Slc8a1","Calb1", # Connecting tubule (CNT)
                     "Slc14a2","Fst","Bst1", # descending thin  limb cells (DTL)
                     #"Akr1b1","Sh3gl3","Prox1", # ascending thin limb cells (ATL)
                     #"Enox1","Thsd4", #Macula densa
                      "Aqp2","Hsd11b2","Scnn1g", # principal cells (PC)
                    "Atp6v1g3","Aqp6","Slc26a7", # Intercalated cells
                    "Krt5","Upk1b","Krt14", # Urothelium
                    "Cdh5","Igfbp3","Pecam1", # Endothelium
                    "Col3a1","Fbn1","Lum","Col1a1", # Fibroblast
                    "Ireb2","Alas2", # Plasmacytoid dentritic cells
                    "S100a8","S100a9","Il1b", # Neutrophil
                    "C1qa","C1qb","Aif1", # Macrophage
                    "Cxcr6","Cd247","Cd3e", # T cells
                    "Igkc","Cd79a","Cd79b", # B cells
                    "Ccl5","Nkg7","Cd7", # NK/Cd8 cells
                    "Cx3cr1", "Ccr2", "H2-Ab1", # reactivate 
                 "Nos2","Ifngr1","Il17a","Il1b","Cd80","Cd86","Fcgr1","Fcgr3","Fcgr2b", #Macrophage 1
                 "Arg1","Il13","Cd163","Mrc1", "Cd68" # Macrophage 2
)


 for (i in Finalcelltypemarkers){
   CellTypeMarkerSpatialFeature<- SpatialFeaturePlot(D5Pevsubcluster, features = i, pt.size.factor = 6000, crop = TRUE)
   #& ggplot2::scale_fill_gradientn(colours = myPalette(4), limits=c(0,10))
  
  ggsave(filename = paste0(i,"_SpatialFeatureAllMarkersDotPlot_Splits.pdf"), plot = CellTypeMarkerSpatialFeature, height = 5, width = 25)
  
}

```


# ############################## 
# DEGs and GO enrichment
# ############################## 

# Biomarker detection from these cluster of PT
```{r}
setwd(CDEGdir)

DefaultAssay(D5Pevsubcluster) <- "SCT"


? FindAllMarkers
D5Pevsubcluster <- ScaleData(object = D5Pevsubcluster, features = rownames(D5Pevsubcluster))
# MAST was used to calculate the cluster
CorMed_nichesBiomarkers <-
  FindAllMarkers(
    object = D5Pevsubcluster,
    logfc.threshold = 0.25,
    test.use = "MAST",
    min.pct = 0.25
  ) # only markers that are in 25% of cells
# save all biomarkers as a dataframe
write.csv(CorMed_nichesBiomarkers, "CorMed_nichesBiomarkers_Mast.csv")

CorMed_nichesBiomarkers
```

# Draw the dotplot, heatmap and featureplot for the biomarkers in each cluster
```{r}
# select the top 3 genes in each cluster and perform the heatmap
CorMed_nichesBiomarkersTop5 <-
  as.data.frame(CorMed_nichesBiomarkers) %>% filter (avg_log2FC > 0.25) %>% group_by(cluster) %>% slice_max(order_by = avg_log2FC, n = 5) %>% pull (gene)

CorMed_nichesBiomarkersTop5 %>% unique()

CorMed_nichesBiomarkersTop5Heatmap<- DoHeatmap(D5Pevsubcluster, features = CorMed_nichesBiomarkersTop5 , slot = "scale.data") + scale_fill_gradientn(colors = c("blue", "white", "red")) + theme(axis.text.y = element_text(size = 10))
ggsave(
  "CorMed_nichesBiomarkersTop5_heatmap.pdf",
  plot = CorMed_nichesBiomarkersTop5Heatmap,
  height = 5,
  width = 5
)


CorMedCorMedPTSubBiomarkersTop5DotPlot <-
  DotPlot(D5Pevsubcluster, features = CorMed_nichesBiomarkersTop5 %>% unique()) +
  RotatedAxis()

ggsave(
  "CorMedCorMedPTSubBiomarkersTop5DotPlot.pdf",
  plot = CorMedCorMedPTSubBiomarkersTop5DotPlot,
  height = 4,
  width = 8
)

# Select the top 5 biomarkers
Top5PTMarker <-
  as.data.frame(CorMed_nichesBiomarkers) %>% 
  filter (avg_log2FC > 0.25) %>% group_by(cluster) %>% 
  slice_max(order_by = avg_log2FC, n = 5) %>% pull (gene) %>% unique()
? FeaturePlot

for (i in Top5PTMarker) {
  
  PTmarkerSpatialFeature <-
    SpatialFeaturePlot(D5Pevsubcluster, features = i, slot = "scale.data",pt.size.factor = 4)
  
  ggsave(
    paste0(i, "_PTSubBiomarkerFeatureSplit.pdf"),
    plot = PTmarkerSpatialFeature,
    height = 4,
    width = 4.5
  )
  
}

```


```{r}
setwd(CGOEndir)
# Generate a table for figure
CorMed_nichesBiomarkers %>% head()
CorMed_infectionSpecifcUpgeneFreqFigure <-
  table(CorMed_nichesBiomarkers$cluster) %>% as.data.frame() %>%
  ggplot(aes(x = Var1, y = Freq)) + geom_bar(stat = "identity") + theme_classic() +
  xlab("CorMed Niches") + ylab("Differentially expressed gene number")

CorMed_infectionSpecifcUpgeneFreqFigure
ggsave(
  "CorMed_nichesBiomarkersnumbersFigure.pdf",
  plot = CorMed_infectionSpecifcUpgeneFreqFigure,
  height = 3,
  width = 3.5
)

# Create a GO comparison for the figure
CorMed_infectionSpecifcUpgene <- list()

Idents(D5Pevsubcluster)
for (n in Idents(D5Pevsubcluster)) {
  # put he DEG into the up-regulated gene for comparision
  CorMed_infectionSpecifcUpgene[[n]] <-
    CorMed_nichesBiomarkers %>% filter(cluster %in% n &
                                        avg_log2FC >= 0.25) %>% pull(gene)
  #}
}
CorMed_infectionSpecifcUpgene$N8%>% head()
CorMed_infectionSpecifcUpgene$N10%>% head()
CorMed_infectionSpecifcUpgene$N11%>% head()
CorMed_infectionSpecifcUpgene$N12%>% head()
CorMed_infectionSpecifcUpgene$N15%>% head()

CorMed_infectionSpecifcUpgeneReorder<- CorMed_infectionSpecifcUpgene[c("N8","N10","N11","N12","N15")]
# change the name order: 
#names(CorMed_infectionSpecifcUpgene) <- c("N8","N10","N11","N12","N15")

CorMed_infectionSpecifcUpgeneReorder$N8%>% head()
CorMed_infectionSpecifcUpgeneReorder$N10%>% head()
CorMed_infectionSpecifcUpgeneReorder$N11%>% head()
CorMed_infectionSpecifcUpgeneReorder$N12%>% head()
CorMed_infectionSpecifcUpgeneReorder$N15%>% head()

# Comparing the Cluster
CorMed_infectionSpecifcUpgeneGOenrich <-
  clusterProfiler::compareCluster(
    geneClusters = CorMed_infectionSpecifcUpgeneReorder,
    fun = "enrichGO",
    OrgDb = "org.Mm.eg.db",
    ont = "BP",
    keyType = 'SYMBOL'
  )

write.csv(CorMed_infectionSpecifcUpgeneGOenrich,
          "CorMed_infectionSpecifcUpgeneGOenrich.csv")

#CorMed_infectionSpecifcUpgeneGOenrich
#CorMed_infectionSpecifcUpgeneGOenrich@compareClusterResult %>% head()

# Here we only concentrate on selected features
selectedPathway<- c("regulation of innate immune response","regulation of adaptive immune response","response to lipopolysaccharide","defense response to bacterium","neutrophil activation", "pattern recognition receptor signaling pathway","phagocytosis", "I-kappaB kinase/NF-kappaB signaling","receptor signaling pathway via STAT","tumor necrosis factor production","T cell differentiation","extracellular matrix organization", "epithelium migration","keratinocyte differentiation","Wnt signaling pathway","regulation of apoptotic signaling pathway")


CorMed_infectionSpecifcUpgeneGOenrichDotPlot <-
  dotplot(
    CorMed_infectionSpecifcUpgeneGOenrich,
    font.size = 12,
    label_format = 80,
    showCategory = selectedPathway
  )
? dotplot
#low = "LightBlue", midpoint=0, mid="white", high = "FireBrick",
ggsave(
  "CorMed_infectionSpecifcUpgeneGOenrichDotPlot.pdf",
  plot = CorMed_infectionSpecifcUpgeneGOenrichDotPlot,
  height = 7,
  width = 7.5
)

```


# ############################## 
# signaling pathway
# ############################## 
```{r}
setwd(CProgenydir)
## we set up with a high memory

options(future.globals.maxSize = 891289600000) 
## We compute the Progeny activity scores and add them to our Seurat object
## as a new assay called Progeny. 
Idents(D5Pevsubcluster)
# create cluster data frame with the cells, Celltypes
CorMedCluster<- data.frame(Cell = names(Idents(D5Pevsubcluster)),   
                              CellType = as.character(Idents(D5Pevsubcluster)),
                              stringsAsFactors = FALSE)

?progeny
D5Pevsubcluster <- progeny(D5Pevsubcluster, scale=FALSE, organism="Mouse", top=500, perm=1, return_assay = TRUE,assay_name = "SCT")
D5Pevsubcluster
# setup the default assay as progeny
DefaultAssay(object = D5Pevsubcluster) <- "progeny"

D5Pevsubcluster <- Seurat::ScaleData(D5Pevsubcluster, assay = "progeny") 
## We can now directly apply Seurat functions in our Progeny scores. 
## For instance, we scale the pathway activity scores. 
progeny_scores_df <- 
  as.data.frame(t(GetAssayData(D5Pevsubcluster, slot = "scale.data", 
                               assay = "progeny"))) %>%
  rownames_to_column("Cell") %>%
  gather(Pathway, Activity, -Cell) 

progeny_scores_df
#progeny_scores_df %>% filter(Cell =="0DPI_AAAAAAAACCACCAGA")
## We match Progeny scores with the cell clusters.
progeny_scores_df <- inner_join(progeny_scores_df, CorMedCluster)

progeny_scores_df %>% head()
## We summarize the Progeny scores by cellpopulation
summarized_progeny_scores <- progeny_scores_df %>% 
  group_by(Pathway, CellType) %>%
  summarise(avg = mean(Activity), std = sd(Activity))
summarized_progeny_scores


## We prepare the data for the plot
summarized_progeny_scores_df <- summarized_progeny_scores %>%
  dplyr::select(-std) %>%   
  spread(Pathway, avg) %>%
  data.frame(row.names = 1, check.names = FALSE, stringsAsFactors = FALSE) 

paletteLength = 80
myColor = colorRampPalette(c("royalblue", "white","lightcoral"))(paletteLength)

progenyBreaks = c(seq(min(summarized_progeny_scores_df), 0, 
                      length.out=ceiling(paletteLength/2) + 1),
                  seq(max(summarized_progeny_scores_df)/paletteLength, 
                      max(summarized_progeny_scores_df), 
                      length.out=floor(paletteLength/2)))
CorMedForHeatmap<-as.data.frame(t(summarized_progeny_scores_df[,-1]))

# generate the heatmap for PT
pdf(file="CorMedForHeatmap_Progeny_ForHeatmap.pdf",height = 3, width = 3.5)
progeny_hmap = pheatmap(CorMedForHeatmap,fontsize=8, 
                        fontsize_row = 8,  show_rownames=T, cluster_cols=T, cluster_rows=T, scale="row",
                        cex=1, clustering_distance_rows="euclidean", cex=1,
                        # clustering_distance_cols="euclidean", clustering_method="complete", 
                        color=myColor, breaks = progenyBreaks, 
                        main = "PROGENy (500)", angle_col = 45,
                        border_color = NA,
                        treeheight_col = 0,   treeheight_row=0)

progeny_hmap
dev.off()
test<- FeaturePlot(D5Pevsubcluster, features = "NFkB")
ggsave("test_NFKB.pdf", plot = test, width = 5, height = 5)
# generate the featureplot 
ProgenyFeatures <- summarized_progeny_scores$Pathway %>% unique()
ProgenyFeatures
for (i in ProgenyFeatures ){
  p2 <-(FeaturePlot(D5Pevsubcluster, features = i) & 
  scale_colour_gradient2(low = 'blue', mid = 'white', high = 'red'))& 
  ggtitle(paste0(i," activity"))
  
  ggsave(paste0(i, "_CorMedInfected_cluster_featurePlot.pdf"), plot = p2, width = 6, height = 6)
  
  p3 <- (SpatialFeaturePlot(D5Pevsubcluster, features = i, pt.size.factor = 4) +ggtitle(paste0(i," activity")))
  ggsave(paste0(i, "_CorMedInfected_cluster_SpatialfeaturePlot.pdf"), plot = p3, width = 6, height = 6)
  
}

```
# ############################## 
# Transcript factor
# ############################## 
```{r}

# Transcription factor activity inference from Immune scRNA-seq

# CollecTRI network
# set up the directory
setwd(CTFdir)
netTF <-  readRDS("/Users/XXW004/Documents/Projects/RuizRosado/PIPseq/Datasets/get_collectri_human_mouse20230716/get_collectri_mouse_process_table.rds")

D5Pevsubcluster@assays$SCT@data %>% head()
mat <- as.matrix(D5Pevsubcluster@assays$SCT@data)
# Run ulm
acts <- run_ulm(mat=mat, net=netTF, .source='source', .target='target',
                .mor='mor', minsize = 5)


saveRDS(acts, file="CorMed_Transcriptfactor.RDS")


#acts <- readRDS("PT_Transcriptfactor.RDS")
# Activity inference with Univariate Linear Model (ULM)
# Extract ulm and store it in tfsulm in pbmc
D5Pevsubcluster[['tfsulm']] <- acts %>%
  pivot_wider(id_cols = 'source', names_from = 'condition',
              values_from = 'score') %>%
  column_to_rownames('source') %>%
  Seurat::CreateAssayObject(.)

# Change assay
DefaultAssay(object = D5Pevsubcluster) <- "tfsulm"

# Scale the data
D5Pevsubcluster <- ScaleData(D5Pevsubcluster)
D5Pevsubcluster@assays$tfsulm@data <- D5Pevsubcluster@assays$tfsulm@scale.data

# Explore the top 20 more varaible TFs
n_tfs <- 20

t(as.matrix(D5Pevsubcluster@assays$tfsulm@data))
# Extract activities from object as a long dataframe
df <- t(as.matrix(D5Pevsubcluster@assays$tfsulm@data)) %>%
  as.data.frame() %>%
  mutate(cluster = Idents(D5Pevsubcluster)) %>%
  pivot_longer(cols = -cluster, names_to = "source", values_to = "score") %>%
  group_by(cluster, source) %>%
  summarise(mean = mean(score))

df
df %>% filter(grepl("Egfr",source))
# Get top tfs with more variable means across clusters
tfs <- df %>%
  group_by(source) %>%
  summarise(std = sd(mean)) %>%
  arrange(-abs(std)) %>%
  head(n_tfs) %>%
  pull(source)

# drop "Znf335" due to not exist in the expression
#tfs2 <- tfs[!tfs == "Tnf"]

#tfs[!tfs == "Znf335"]
# Subset long data frame to top tfs and transform to wide matrix
top_acts_mat <- df %>%
  filter(source %in% tfs) %>%
  pivot_wider(id_cols = 'cluster', names_from = 'source',
              values_from = 'mean') %>%
  column_to_rownames('cluster') %>%
  as.matrix()

# Choose color palette
palette_length = 100
my_color = colorRampPalette(c("Darkblue", "white","red"))(palette_length)

my_breaks <- c(seq(-3, 0, length.out=ceiling(palette_length/2) + 1),
               seq(0.05, 3, length.out=floor(palette_length/2)))

# Plot
PTTFheatmap<- pheatmap(t(top_acts_mat),border_color = NA, cluster_cols = F, 
                        color=my_color,fontsize=12, fontsize_row = 10, 
                        breaks = my_breaks, 
                        #main = "Predicted TF activities", 
                        #angle_col = 90,
                        treeheight_col = 0, treeheight_row=0)


ggsave("CorMedInfectionHeatmap_Transcriptfactor_Progeny_Decouple.pdf", plot = PTTFheatmap, width = 3, height = 4)

# draw the transcriptor factor activity and their expression
# generate the figure of transcript factor activity:
for (m in tfs){
  p2 <- (SpatialFeaturePlot(D5Pevsubcluster, features = m,pt.size.factor = 4) +
  #scale_colour_gradient2(low = 'blue', mid = 'white', high = 'red')) +
  ggtitle(paste0(m, ' activity')))
  
  ggsave(paste0("TFActivity_",m,"_CorMedInfection_SpatialFeaturePlot.pdf"), plot = p2, width = 6, height = 6)
}

D5Pevsubcluster
DefaultAssay(object = D5Pevsubcluster) <- "SCT"

for (n in tfs){
  p3 <- (FeaturePlot(D5Pevsubcluster, features = n,slot= "scale.data") + 
  #scale_colour_gradient2(low = 'blue', mid = 'white', high = 'red')) +
  ggtitle(paste0(n, ' expression')))
  
  p4 <- (SpatialFeaturePlot(D5Pevsubcluster, features = n, pt.size.factor = 4, slot= "scale.data") +
 # scale_colour_gradient2(low = 'blue', mid = 'white', high = 'red')) +
  ggtitle(paste0(n, ' expression (time)')))
 
  ggsave(paste0("TFExpression_",n,"_D5Pevsubcluster_FeaturePlot.pdf"), plot = p3, width = 6, height = 6)
  ggsave(paste0("TFExpression_",n,"_D5Pevsubcluster_SpatilFeaturePlot.pdf"), plot = p4, width = 6, height = 6)

}


# add their activity in Dotplot
Idents(D5Pevsubcluster)
# get the order of row name
GeneOrderByPheatmap <- rownames(t(top_acts_mat))[PTTFheatmap$tree_row$order]
#IMMTFheatmap$tree_row$order
GeneOrderByPheatmap
?DotPlot
TFDotPlot <- DotPlot(D5Pevsubcluster, features = rev(GeneOrderByPheatmap)) +
  RotatedAxis() + coord_flip()+ 
  #ggtitle("Predicted TF expression")+
   theme(legend.position = "right")
ggsave("CorMed_TFDotPlot.pdf", plot = TFDotPlot, width = 5, height = 6)

```



# Please ignore the following datasets


# ############################## 
# niche-niche communications
# ############################## 

# refernece: https://github.com/saeyslab/nichenetr/blob/master/vignettes/differential_nichenet.md
# Run the nichenet_seruratobj_aggregate for the different regions
```{r}
DefaultAssay(D5Pevsubcluster) <- "SCT"
D5Pevsubcluster@meta.data %>% head()
#Idents(D5Pevsubcluster) <- D5Pevsubcluster@meta.data$Sub2

# reset the identity, Combine the PT cells

Idents(D5Pevsubcluster)
D5Pevsubcluster@meta.data
# adjust the levels
# Idents(D5Pevsubcluster) <-
# ordered(factor(Idents(D5Pevsubcluster)), levels=c( "5_1","10_1","10_0","2_1","2_0","5_0","5_2","4","7","0","1","9","6","3","8"))

levels(Idents(D5Pevsubcluster))
```

# use the wrap 
```{r}
# sender
sender_cluster <- c("N8","N10","N11","N12","N15")

# define receive cluster

receiver_cluster <- c("N15")
D5Pevsubcluster@meta.data %>% head()
```


```{r}

ligand_target_matrix <-
    readRDS(paste0(data_path, "ligand_target_matrix_nsga2r_final_mouse.rds"))

lr_network <-
    readRDS(paste0(data_path, "lr_network_mouse_21122021.rds"))

ligand_target_matrix %>% head()
lr_network = lr_network %>% dplyr::distinct(from, to)

weighted_networks <-
    readRDS(paste0(data_path, "weighted_networks_nsga2r_final_mouse.rds"))

weighted_networks_lr <-
    weighted_networks$lr_sig %>%
    inner_join(lr_network %>% distinct(from, to),
               by = c("from", "to"))


D5Pevsubcluster = alias_to_symbol_seurat(D5Pevsubcluster, "mouse")

D5Pevsubcluster@meta.data %>% head()
D5Pevsubcluster@meta.data$IntegrateAnnot %>% table() 

head(weighted_networks$gr) 
DimPlot(D5Pevsubcluster)

# If you use convert_to_alias before here, this one won't work
D5Pevsubcluster = Seurat::PrepSCTFindMarkers(D5Pevsubcluster, assay = "SCT", verbose = FALSE)
lr_network = lr_network %>% dplyr::rename(ligand = from, receptor = to) %>% distinct(ligand, receptor)

# define niches
niches <- list()
niches = list(
    "Abcess_niche" = list(
      "sender" = c("N12","N11","N10","N8"),
      "receiver" = c("N15")),
    "Margen_niche" = list(
      "sender" = c("N15","N11","N10","N8"),
      "receiver" = c("N12"))
  )


lr_network %>% head()
D5Pevsubcluster %>% subset(features = lr_network$ligand %>% intersect(rownames(D5Pevsubcluster)))
# calcualte the niches difference 
DE_sender = nichenetr::calculate_niche_de(seurat_obj  = D5Pevsubcluster %>% subset(features = lr_network$ligand %>% intersect(rownames(D5Pevsubcluster))), niches = niches, type = "sender", assay_oi = "SCT") # only ligands important for sender cell types
DE_receiver = nichenetr::calculate_niche_de(seurat_obj  = D5Pevsubcluster %>% subset(features = lr_network$receptor %>% unique()), niches = niches, type = "receiver", assay_oi = "SCT") # only receptors now, later on: DE analysis to find targets


DE_sender = DE_sender %>% mutate(avg_log2FC = ifelse(avg_log2FC == Inf, max(avg_log2FC[is.finite(avg_log2FC)]), ifelse(avg_log2FC == -Inf, min(avg_log2FC[is.finite(avg_log2FC)]), avg_log2FC)))
DE_receiver = DE_receiver %>% mutate(avg_log2FC = ifelse(avg_log2FC == Inf, max(avg_log2FC[is.finite(avg_log2FC)]), ifelse(avg_log2FC == -Inf, min(avg_log2FC[is.finite(avg_log2FC)]), avg_log2FC)))

# Process DE results:
expression_pct = 0.10
DE_sender_processed = nichenetr::process_niche_de(DE_table = DE_sender, niches = niches, expression_pct = expression_pct, type = "sender")
DE_receiver_processed =nichenetr::process_niche_de(DE_table = DE_receiver, niches = niches, expression_pct = expression_pct, type = "receiver")
# Combine sender-receiver DE based on L-R pairs:
specificity_score_LR_pairs = "min_lfc"
DE_sender_receiver = nichenetr::combine_sender_receiver_de(DE_sender_processed, DE_receiver_processed, lr_network, specificity_score = specificity_score_LR_pairs)
DE_sender_receiver

# 4. Calculate ligand activities and infer active ligand-target links

lfc_cutoff = 0.15 # recommended for 10x as min_lfc cutoff. 
specificity_score_targets = "min_lfc"

DE_receiver_targets = nichenetr::calculate_niche_de_targets(seurat_obj = D5Pevsubcluster, niches = niches, lfc_cutoff = lfc_cutoff, expression_pct = expression_pct, assay_oi = "SCT") 

DE_receiver_processed_targets = nichenetr::process_receiver_target_de(DE_receiver_targets = DE_receiver_targets, niches = niches, expression_pct = expression_pct, specificity_score = specificity_score_targets)
  
background = DE_receiver_processed_targets  %>% pull(target) %>% unique()

geneset_Abcess = DE_receiver_processed_targets %>% filter(receiver == niches$Abcess_niche$receiver & target_score >= lfc_cutoff & target_significant == 1 & target_present == 1) %>% pull(target) %>% unique()
geneset_Margin = DE_receiver_processed_targets %>% filter(receiver == niches$Margen_niche$receiver & target_score >= lfc_cutoff & target_significant == 1 & target_present == 1) %>% pull(target) %>% unique()

# Good idea to check which genes will be left out of the ligand activity analysis (=when not present in the rownames of the ligand-target matrix).
# If many genes are left out, this might point to some issue in the gene naming (eg gene aliases and old gene symbols, bad human-mouse mapping)
geneset_Abcess %>% setdiff(rownames(ligand_target_matrix))
### [1] "Wfdc17"        "AW112010"      "2900097C17Rik" "B430306N03Rik" "AC149090.1"
geneset_Margin %>% setdiff(rownames(ligand_target_matrix))


length(geneset_Abcess)
## [1] 17
length(geneset_Margin)



nichenet_output = nichenet_seuratobj_aggregate(
  seurat_obj = D5Pevsubcluster, 
  receiver = "PT", 
  condition_colname = "DataSet", condition_oi = "7DPI", condition_reference = "0DPI", 
  sender = c("FIB","M1M2","RecMAC","NEU","ResIMM","T"), 
  ligand_target_matrix = ligand_target_matrix,
  lr_network = lr_network,
  weighted_networks = weighted_networks)

nichenet_output$ligand_target_heatmap
nichenet_output$ligand_receptor_heatmap

ggsave(filename = "PIPseq_Cell_Cell_Communication_v1011.pdf",nichenet_output$ligand_activity_target_heatmap, width = 28, height = 9)

ggsave(filename = "PIPseq_Cell_Cell_Communication_ligandtargetheatmap_v1011.pdf",nichenet_output$ligand_target_heatmap, width = 15, height = 9)
ggsave(filename = "PIPseq_Cell_Cell_Communication_ligandreceptor_heatmapp_v1011.pdf",nichenet_output$ligand_receptor_heatmap, width = 15, height = 9)


```

# draw the Circos plots
```{r}
# Calculate average ligand expression in sender cells
# avg_expression_ligands = AverageExpression(seuratObj %>% subset(subset = aggregate == "LCMV"),features = nichenet_output$top_ligands) # if want to look specifically in LCMV-only cells
avg_expression_ligands = AverageExpression(D5Pevsubcluster, features = nichenet_output$top_ligands)

# Assign ligands to sender cells
sender_ligand_assignment = avg_expression_ligands$RNA %>% apply(1, function(ligand_expression){
  ligand_expression > (ligand_expression %>% mean() + ligand_expression %>% sd())
  }) %>% t()
sender_ligand_assignment = sender_ligand_assignment %>% apply(2, function(x){x[x == TRUE]}) %>% purrr::keep(function(x){length(x) > 0})
names(sender_ligand_assignment)

# Determine now which prioritized ligands are expressed by CAFs and or endothelial cells

all_assigned_ligands = sender_ligand_assignment %>% lapply(function(x){names(x)}) %>% unlist()
all_assigned_ligands
unique_ligands = all_assigned_ligands %>% table() %>% .[. == 1] %>% names()

general_ligands = nichenet_output$top_ligands %>% setdiff(unique_ligands)


sender_ligand_assignment$`FIB` %>% names()%>% setdiff(general_ligands)


FIB_specific_ligands = sender_ligand_assignment$`FIB` %>% names() %>% setdiff(general_ligands)

FIB_specific_ligands

PT_specific_ligands = sender_ligand_assignment$`PT` %>% names() %>% setdiff(general_ligands)

PT_specific_ligands

RecMAC_specific_ligands = sender_ligand_assignment$`RecMAC` %>% names() %>% setdiff(general_ligands)

RecMAC_specific_ligands

NEU_specific_ligands = sender_ligand_assignment$`NEU` %>% names() %>% setdiff(general_ligands)

NEU_specific_ligands

M1M2_specific_ligands = sender_ligand_assignment$`M1M2` %>% names() %>% setdiff(general_ligands)

M1M2_specific_ligands


#IC_specific_ligands = sender_ligand_assignment$IC %>% names() %>% setdiff(general_ligands)
#IC_specific_ligands

#PC_specific_ligands = sender_ligand_assignment$PC %>% names() %>% setdiff(general_ligands)
#PC_specific_ligands
PT_specific_ligands
ligand_type_indication_df = tibble(
  ligand_type = c(rep("PT-specific", times = PT_specific_ligands %>% length()),
                  rep("NEU-specific", times = NEU_specific_ligands %>% length()),
                  rep("RecMAC-specific", times = RecMAC_specific_ligands %>% length()),
                  rep("M1M2-specific", times = M1M2_specific_ligands %>% length()),
                   rep("FIB-specific", times = FIB_specific_ligands %>% length()),
                  #rep("IC-specific", times = IC_specific_ligands %>% length()),
                  rep("General", times = general_ligands %>% length())),
  ligand = c(PT_specific_ligands, NEU_specific_ligands, RecMAC_specific_ligands, M1M2_specific_ligands, FIB_specific_ligands, general_ligands))

ligand_type_indication_df
```

```{r}
# Define the ligand-target links of interest
active_ligand_target_links_df = nichenet_output$ligand_target_df %>% mutate(target_type = "7DPI") %>% inner_join(ligand_type_indication_df) # if you want ot make circos plots for multiple gene sets, combine the different data frames and differentiate which target belongs to which gene set via the target type

active_ligand_target_links_df

cutoff_include_all_ligands = active_ligand_target_links_df$weight %>% quantile(0.40)

active_ligand_target_links_df_circos = active_ligand_target_links_df %>% filter(weight > cutoff_include_all_ligands)

ligands_to_remove = setdiff(active_ligand_target_links_df$ligand %>% unique(), active_ligand_target_links_df_circos$ligand %>% unique())
targets_to_remove = setdiff(active_ligand_target_links_df$target %>% unique(), active_ligand_target_links_df_circos$target %>% unique())
  
```

# Prepare the circos visualization: give each segment of ligands and targets a specific color and order
```{r}
circos_links = active_ligand_target_links_df %>% filter(!target %in% targets_to_remove &!ligand %in% ligands_to_remove)
circos_links

grid_col_ligand =c("General" = "steelblue2",
            "RecMAC-specific" = "red",
            "NEU-specific" = "violet",
            "M1M2-specific" = "darkgreen",
            "FIB-specific" = "lawngreen",
            "PT-specific" = "royalblue"
            )
grid_col_target =c(
            "7DPI" = "darkgray")

grid_col_tbl_ligand = tibble(ligand_type = grid_col_ligand %>% names(), color_ligand_type = grid_col_ligand)
grid_col_tbl_target = tibble(target_type = grid_col_target %>% names(), color_target_type = grid_col_target)

circos_links = circos_links %>% mutate(ligand = paste(ligand," ")) # extra space: make a difference between a gene as ligand and a gene as target!
circos_links = circos_links %>% inner_join(grid_col_tbl_ligand) %>% inner_join(grid_col_tbl_target)

circos_links

links_circle = circos_links %>% dplyr::select(ligand,target, weight)

ligand_color = circos_links %>% distinct(ligand,color_ligand_type)
grid_ligand_color = ligand_color$color_ligand_type %>% set_names(ligand_color$ligand)
target_color = circos_links %>% distinct(target,color_target_type)
grid_target_color = target_color$color_target_type %>% set_names(target_color$target)

grid_col =c(grid_ligand_color,grid_target_color)


# give the option that links in the circos plot will be transparant ~ ligand-target potential score
transparency = circos_links %>% mutate(weight =(weight-min(weight))/(max(weight)-min(weight))) %>% mutate(transparency = 1-weight) %>% .$transparency 

transparency

# prepare circos
target_order = circos_links$target %>% unique()

ligand_order = c(PT_specific_ligands, NEU_specific_ligands, RecMAC_specific_ligands, M1M2_specific_ligands, FIB_specific_ligands, general_ligands) %>% c(paste(.," ")) %>% intersect(circos_links$ligand)
order = c(ligand_order,target_order)
# Prepare the circos visualization: define the gaps between the different segments
width_same_cell_same_ligand_type = 0.5
width_different_cell = 6
width_ligand_target = 15
width_same_cell_same_target_type = 0.5

gaps = c(
  # width_ligand_target,
  rep(width_same_cell_same_ligand_type, times = (circos_links %>% filter(ligand_type == "FIB-specific") %>% distinct(ligand) %>% nrow() -1)),
  width_different_cell,
  rep(width_same_cell_same_ligand_type, times = (circos_links %>% filter(ligand_type == "NEU-specific") %>% distinct(ligand) %>% nrow() -1)),
  width_different_cell,
  rep(width_same_cell_same_ligand_type, times = (circos_links %>% filter(ligand_type == "RecMAC-specific") %>% distinct(ligand) %>% nrow() -1)),
  width_different_cell,
  rep(width_same_cell_same_ligand_type, times = (circos_links %>% filter(ligand_type == "M1M2-specific") %>% distinct(ligand) %>% nrow() -1)),
  width_different_cell,
    rep(width_same_cell_same_ligand_type, times = (circos_links %>% filter(ligand_type == "PT-specific") %>% distinct(ligand) %>% nrow() -1)),
  width_different_cell,
  rep(width_same_cell_same_ligand_type, times = (circos_links %>% filter(ligand_type == "General") %>% distinct(ligand) %>% nrow() -1)),
  width_ligand_target,
  rep(width_same_cell_same_target_type, times = (circos_links %>% filter(target_type == "7DPI") %>% distinct(target) %>% nrow() -1)),
  width_ligand_target
  )
```

```{r}
circos.par(gap.degree = gaps)
chordDiagram(links_circle, directional = 1,order=order,link.sort = TRUE, link.decreasing = FALSE, grid.col = grid_col,transparency = 0, diffHeight = 0.005, direction.type = c("diffHeight", "arrows"),link.arr.type = "big.arrow", link.visible = links_circle$weight >= cutoff_include_all_ligands,annotationTrack = "grid", 
    preAllocateTracks = list(track.height = 0.075))
# we go back to the first track and customize sector labels
circos.track(track.index = 1, panel.fun = function(x, y) {
    circos.text(CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index,
        facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.55), cex = 1)
}, bg.border = NA) #

circos.clear()
```

```{r}
svg("ligand_receptor_circos.svg", width = 12, height = 12)
circos.par(gap.degree = gaps)
chordDiagram(links_circle, directional = 1,order=order,link.sort = TRUE, link.decreasing = FALSE, grid.col = grid_col,transparency = transparency, diffHeight = 0.005, direction.type = c("diffHeight", "arrows"),link.arr.type = "big.arrow", link.visible = links_circle$weight >= cutoff_include_all_ligands,annotationTrack = "grid",
    preAllocateTracks = list(track.height = 0.075))
# we go back to the first track and customize sector labels
circos.track(track.index = 1, panel.fun = function(x, y) {
    circos.text(CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index,
        facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.55), cex = 0.8)
}, bg.border = NA) #
circos.clear()
dev.off()
```












# ################
# Generate the Day 0
# scatter pie plot for different cell types at day 0
```{r}
setwd(Contrdir)
Pyelonephritis_InfectionSubslidesD0 <-
    subset (Pyelonephritis_Infection, orig.ident == "PyeloD0_1")
Pyelonephritis_InfectionSubslidesD0
  # there seems to be an error in the susetting, so we removed other igmages
  #names(Pyelonephritis_InfectionSubslides@images)
SelectedImageName <- names(Pyelonephritis_InfectionSubslidesD0@images)[1]
SelectedImageName
OtherImages <- Allimagmes[Allimagmes != SelectedImageName]
OtherImages
Pyelonephritis_InfectionSubslidesD0@images[OtherImages] = NULL

#nrow(Pyelonephritis_InfectionSubslidesD5@meta.data )
SpatialDimPlot(Pyelonephritis_InfectionSubslidesD0, crop = T)

# the prediction of the object
Pyelonephritis_InfectionSubslidesD0[["predictions"]]
InfectedMat_D0<- t(Pyelonephritis_InfectionSubslidesD0[["predictions"]]@data)
colnames(InfectedMat_D0) <- ordered (colnames(InfectedMat_D0), levels =CelltypeOrder)
# change the order
InfectedMat_D0<- InfectedMat_D0[ ,CelltypeOrder]
# for final celltype matrix: 
InfectedMat_D0CellType<- InfectedMat_D0[,!colnames(InfectedMat_D0) %in% c("max")]
InfectedMat_D0CellTypeNozero <- InfectedMat_D0CellType[,colSums(InfectedMat_D0CellType)>0]


# correlation
InfectedMat_D0CellTypeCorrelationMatrix<-plotCorrelationMatrix(InfectedMat_D0CellTypeNozero)
InfectedMat_D0CellTypeInteractions<- plotInteractions(InfectedMat_D0CellTypeNozero, "heatmap") + scale_fill_gradientn(colors = c("blue", "white", "red"))

ggsave("SpatialScatterPieDay0_CorrelationMatrix.pdf", plot =InfectedMat_D0CellTypeCorrelationMatrix, height = 6, width = 6 )

ggsave("SpatialScatterPieDay0_HeatmapColocalization.pdf", plot =InfectedMat_D0CellTypeInteractions, height = 6, width = 6 )
# scatterpie plot
# scatterpie plot
# 
ct <- colnames(InfectedMat_D0CellType)
ct
# we did not add the low proportion in the scatterpie
InfectedMat_D0CellType[InfectedMat_D0CellType < 0.1] <- 0
paletteMartin <- c(
    "#b6dbff", # HeaPT-S1
    "#99CCFF", # HeaPT-S2
    "#0099FF", # HeaPT-S3
    "#6699FF", # HeaPT-S4
    "#006ddb", # HeaPT-S5
    "#66CC99", # DegPT
    "#EE4E34", # MalaPT
    "#F5DEB3", # infiPT
    "#BEE5BF", # HybridPT
    "#FFD700", # CNT
    "#bdbdbd", # DTL
    "#b66dff", #TAL
    "#FF9900", #DCT-TAL
    "#F96167", #IC
    "#CCF381", #PC
    "#ff6db6", #URO
    "#C5DECD", #ENO
    "#FFCC00", #FIB
    "#F4FEC1", #PL
    "#CCFF33", #ResIMM
    "#99FF66", # RecMAC
    "#A1E8CC", # M1-M2
    "#FF00FF", #NEU
    "#DFF3E3", # T
    "#E2D1F9", #B
    "#CC0033" #NK
  )
#DefaultAssay(Pyelonephritis_InfectionSubslidesD5) <- "Spatial"

# choose three color
# pal<-colorRampPalette(c("LightBlue","white","FireBrick"))(length(ct))
# choose the selected color
pal <- colorRampPalette(paletteMartin)(length(ct))

# choose the spectral range colors:
# https://earlglynn.github.io/RNotes/package/RColorBrewer/index.html
#pal <- (colorRampPalette(brewer.pal(11,"Paired"))(length(ct)))

names(pal) <- ct
#pal
rownames(Pyelonephritis_InfectionSubslidesD0)
colnames(Pyelonephritis_InfectionSubslidesD0)
str(Pyelonephritis_InfectionSubslidesD0)
#SPOTlight:::. extract_image(Pyelonephritis_Infection )
#rownames(Pyelonephritis_Infection)
SpatialScatterPieDay0 <-plotSpatialScatterpie(
  x= Pyelonephritis_InfectionSubslidesD0,
  y= InfectedMat_D0CellType,
  cell_types = colnames(InfectedMat_D0CellType),
    img = TRUE,
    scatterpie_alpha = 1,
    pie_scale = 0.4) +
    scale_fill_manual(
        values = pal,
        breaks = names(pal)) +coord_sf(xlim = c(200, 450), ylim = c(150, 450))

ggsave("SpatialScatterPieDay0.pdf",plot = SpatialScatterPieDay0, height = 4,width = 5)
# colnames(DeconvolutedMatrix)
# ncol(Pyelonephritis_Infection)
# nrow(DeconvolutedMatrix)
InfectedMat_D0CellType
pdf(file = "SpatialScatterPieDay0_CellTypeNetwork.pdf", height = 8,width = 8)
plotInteractions(InfectedMat_D0CellType, "network")
dev.off()

Idents(Pyelonephritis_InfectionSubslidesD0)

# generate the Dotplot for the biomarkers
DefaultAssay(Pyelonephritis_InfectionSubslidesD0) <-"SCT"
Finalcelltypemarkers<- c("Lrp2","Slc34a1","Slc13a3", # Proximal tubule cells (PT)
                      "Slc12a3","Pvalb","Wnk1",# Distal connecting tublue (DCT)

                     "Umod","Slc12a1","Cldn10", # Thick ascending limb cells (TAL)
                      "Klk1","Slc8a1","Calb1", # Connecting tubule (CNT)
                     "Slc14a2","Fst","Bst1", # descending thin  limb cells (DTL)
                     #"Akr1b1","Sh3gl3","Prox1", # ascending thin limb cells (ATL)
                     #"Enox1","Thsd4", #Macula densa
                      "Aqp2","Hsd11b2","Scnn1g", # principal cells (PC)
                    "Atp6v1g3","Aqp6","Slc26a7", # Intercalated cells
                    "Krt5","Upk1b","Krt14", # Urothelium
                    "Cdh5","Igfbp3","Pecam1", # Endothelium
                    "Col3a1","Fbn1","Lum","Col1a1", # Fibroblast
                    "Ireb2","Alas2","C78334", # Plasmacytoid dentritic cells
                    "S100a8","S100a9","Il1b", # Neutrophil
                    "C1qa","C1qb","Aif1", # Macrophage
                    "Cxcr6","Cd247","Cd3e", # T cells
                    "Igkc","Cd79a","Cd79b", # B cells
                    "Ccl5","Nkg7","Cd7" # NK/Cd8 cells
)

SpatialD0MarkersDotPlot<- DotPlot(Pyelonephritis_InfectionSubslidesD0, features = Finalcelltypemarkers,cols = "Spectral", dot.scale = 4) +RotatedAxis() +theme(legend.text = element_text(size = 12), legend.title = element_text(size = 8))

ggsave("SpatialD0MarkersDotPlot.pdf", plot = SpatialD0MarkersDotPlot, height = 6, width = 14)
Pyelonephritis_InfectionSubslidesD0

for (i in Finalcelltypemarkers){
   CellTypeMarkerSpatialFeature<- SpatialFeaturePlot(Pyelonephritis_InfectionSubslidesD0, features = i, pt.size.factor = 1.6, crop = TRUE) 
   #&
       #   ggplot2::scale_fill_gradientn(colours = myPalette(4), limits=c(0,1))
  
  ggsave(filename = paste0(i,"_SpatialFeaturePrediction.pdf"), plot = CellTypeMarkerSpatialFeature, height = 5, width = 5)
  
}

```


# ################
# Generate the Day 5
# scatter pie plot for different cell types at day 5
```{r}
setwd(Day7dir)

Pyelonephritis_Infection$orig.ident
Pyelonephritis_InfectionSubslidesD5 <-
    subset (Pyelonephritis_Infection, orig.ident == "PyeloD7_1")
Pyelonephritis_InfectionSubslidesD5
  # there seems to be an error in the susetting, so we removed other igmages
  #names(Pyelonephritis_InfectionSubslides@images)
SelectedImageName <- names(Pyelonephritis_InfectionSubslidesD5@images)[5]
SelectedImageName
OtherImages <- Allimagmes[Allimagmes != SelectedImageName]
OtherImages
Pyelonephritis_InfectionSubslidesD5@images[OtherImages] = NULL

#nrow(Pyelonephritis_InfectionSubslidesD5@meta.data )
Pyelonephritis_InfectionSubslidesD5Dimplot <-SpatialDimPlot(Pyelonephritis_InfectionSubslidesD5, crop = T)

ggsave("Pyelonephritis_InfectionSubslidesD5Dimplot.pdf", plot =Pyelonephritis_InfectionSubslidesD5Dimplot, height = 6, width = 6 )

# the prediction of the object
Pyelonephritis_InfectionSubslidesD5[["predictions"]]
InfectedMat_D7<- t(Pyelonephritis_InfectionSubslidesD5[["predictions"]]@data)
colnames(InfectedMat_D7) <- ordered (colnames(InfectedMat_D7), levels =CelltypeOrder)
# change the order
InfectedMat_D7<- InfectedMat_D7[ ,CelltypeOrder]
InfectedMat_D7
# for final celltype matrix: 
InfectedMat_D7CellType<- InfectedMat_D7[,!colnames(InfectedMat_D7) %in% c("max")]
InfectedMat_D7CellTypeNozero <- InfectedMat_D7CellType[,colSums(InfectedMat_D7CellType)>0]


# correlation
InfectedMat_D7CellTypeCorrelationMatrix<-plotCorrelationMatrix(InfectedMat_D7CellTypeNozero)
InfectedMat_D7CellTypeInteractions<- plotInteractions(InfectedMat_D7CellTypeNozero, "heatmap") + scale_fill_gradientn(colors = c("blue", "white", "red"))

ggsave("SpatialScatterPieDay7_CorrelationMatrix.pdf", plot =InfectedMat_D7CellTypeCorrelationMatrix, height = 6, width = 6 )

ggsave("SpatialScatterPieDay7_HeatmapColocalization.pdf", plot =InfectedMat_D7CellTypeInteractions, height = 6, width = 6 )
# scatterpie plot
# scatterpie plot
# 
ct <- colnames(InfectedMat_D7CellType)
ct
# we did not add the low proportion in the scatterpie
InfectedMat_D7CellType[InfectedMat_D7CellType < 0.01] <- 0
paletteMartin <- c(
    "#b6dbff", # HeaPT-S1
    "#99CCFF", # HeaPT-S2
    "#0099FF", # HeaPT-S3
    "#6699FF", # HeaPT-S4
    "#006ddb", # HeaPT-S5
    "#66CC99", # DegPT
    "#EE4E34", # MalaPT
    "#F5DEB3", # infiPT
    "#BEE5BF", # HybridPT
    "#FFD700", # CNT
    "#bdbdbd", # DTL
    "#b66dff", #TAL
    "#FF9900", #DCT-TAL
    "#F96167", #IC
    "#CCF381", #PC
    "#ff6db6", #URO
    "#C5DECD", #ENO
    "#FFCC00", #FIB
    "#F4FEC1", #PL
    "#CCFF33", #ResIMM
    "#99FF66", # RecMAC
    "#A1E8CC", # M1-M2
    "#FF00FF", #NEU
    "#DFF3E3", # T
    "#E2D1F9", #B
    "#CC0033" #NK
  )
#DefaultAssay(Pyelonephritis_InfectionSubslidesD5) <- "Spatial"

# choose three color
# pal<-colorRampPalette(c("LightBlue","white","FireBrick"))(length(ct))
# choose the selected color
pal <- colorRampPalette(paletteMartin)(length(ct))

# choose the spectral range colors:
# https://earlglynn.github.io/RNotes/package/RColorBrewer/index.html
#pal <- (colorRampPalette(brewer.pal(11,"Paired"))(length(ct)))

names(pal) <- ct
#pal
rownames(Pyelonephritis_InfectionSubslidesD5)
colnames(Pyelonephritis_InfectionSubslidesD5)
str(Pyelonephritis_InfectionSubslidesD5)
#SPOTlight:::. extract_image(Pyelonephritis_Infection )
#rownames(Pyelonephritis_Infection)
SpatialScatterPieDay7 <-plotSpatialScatterpie(
  x= Pyelonephritis_InfectionSubslidesD5,
  y= InfectedMat_D7CellType,
  cell_types = colnames(InfectedMat_D7CellType),
    img = TRUE,
    scatterpie_alpha = 1,
    pie_scale = 0.4) +
    scale_fill_manual(
        values = pal,
        breaks = names(pal)) +coord_sf(xlim = c(100, 500), ylim = c(100, 500))

ggsave("SpatialScatterPieDay7.pdf",plot = SpatialScatterPieDay7, height = 4,width = 5)
# colnames(DeconvolutedMatrix)
# ncol(Pyelonephritis_Infection)
# nrow(DeconvolutedMatrix)
InfectedMat_D7CellType
pdf(file = "SpatialScatterPieDay7_CellTypeNetwork.pdf", height = 8,width = 8)
plotInteractions(InfectedMat_D7CellType, "network")
dev.off()

Idents(Pyelonephritis_InfectionSubslidesD5)

# generate the Dotplot for the biomarkers
DefaultAssay(Pyelonephritis_InfectionSubslidesD5) <-"SCT"
Finalcelltypemarkers<- c("Lrp2","Slc34a1","Slc13a3", # Proximal tubule cells (PT)
                      "Slc12a3","Pvalb","Wnk1",# Distal connecting tublue (DCT)

                     "Umod","Slc12a1","Cldn10", # Thick ascending limb cells (TAL)
                      "Klk1","Slc8a1","Calb1", # Connecting tubule (CNT)
                     "Slc14a2","Fst","Bst1", # descending thin  limb cells (DTL)
                     #"Akr1b1","Sh3gl3","Prox1", # ascending thin limb cells (ATL)
                     #"Enox1","Thsd4", #Macula densa
                      "Aqp2","Hsd11b2","Scnn1g", # principal cells (PC)
                    "Atp6v1g3","Aqp6","Slc26a7", # Intercalated cells
                    "Krt5","Upk1b","Krt14", # Urothelium
                    "Cdh5","Igfbp3","Pecam1", # Endothelium
                    "Col3a1","Fbn1","Lum","Col1a1", # Fibroblast
                    "Ireb2","Alas2","C78334", # Plasmacytoid dentritic cells
                    "S100a8","S100a9","Il1b", # Neutrophil
                    "C1qa","C1qb","Aif1", # Macrophage
                    "Cxcr6","Cd247","Cd3e", # T cells
                    "Igkc","Cd79a","Cd79b", # B cells
                    "Ccl5","Nkg7","Cd7" # NK/Cd8 cells
)

SpatialD7MarkersDotPlot<- DotPlot(Pyelonephritis_InfectionSubslidesD5, features = Finalcelltypemarkers,cols = "Spectral", dot.scale = 4) +RotatedAxis() +theme(legend.text = element_text(size = 12), legend.title = element_text(size = 8))

ggsave("SpatialD7MarkersDotPlot.pdf", plot = SpatialD7MarkersDotPlot, height = 6, width = 14)
Pyelonephritis_InfectionSubslidesD5

for (i in Finalcelltypemarkers){
   CellTypeMarkerSpatialFeature<- SpatialFeaturePlot(Pyelonephritis_InfectionSubslidesD5, features = i, pt.size.factor = 1.6, crop = TRUE) 
   #&
       #   ggplot2::scale_fill_gradientn(colours = myPalette(4), limits=c(0,1))
  
  ggsave(filename = paste0(i,"_SpatialFeaturePrediction_day7.pdf"), plot = CellTypeMarkerSpatialFeature, height = 5, width = 5)
  
}

Pdate ="PyeloD7_1"
pdf(paste0(Pdate,"_MeanProp_tidyHeatmap.pdf"),height = 5, width = 6)
  
   MeanPropForHeatmap <-FinalIntergratedTable %>% filter(orig.ident==Pdate) %>% dplyr::select(-c("Row.names",'orig.ident',"max")) %>% group_by(Annotation) %>% summarise_all("mean") %>% remove_rownames %>% column_to_rownames(var="Annotation") %>% as.matrix()
   # reorder the matrix
   MeanPropForHeatmapReordered <- MeanPropForHeatmap[,CelltypeOrder]
   MeanPropForHeatmapReordered
   # eliminate the annotation with zero sum
   MeanPropForHeatmapNoZeroHeatmap <-MeanPropForHeatmapReordered[,colSums(MeanPropForHeatmapReordered)>0]%>% Heatmap(cluster_rows =F, cluster_columns = F, show_row_dend=F, show_column_dend = F,column_names_rot = 45,name = "mean",col= col_fun, border = T)  
  print(MeanPropForHeatmapNoZeroHeatmap)
  dev.off()

```

# we generate pie plot for day7
```{r}
# set up the day 7
setwd(InfCPiedir)
Pyelonephritis_Infection$orig.ident
Pyelonephritis_InfectionSubslidesD5 <-
    subset (Pyelonephritis_Infection, orig.ident == "PyeloD7_1")
Pyelonephritis_InfectionSubslidesD5
  # there seems to be an error in the susetting, so we removed other igmages
  #names(Pyelonephritis_InfectionSubslides@images)
SelectedImageName <- names(Pyelonephritis_InfectionSubslidesD5@images)[5]
SelectedImageName
OtherImages <- Allimagmes[Allimagmes != SelectedImageName]
OtherImages
Pyelonephritis_InfectionSubslidesD5@images[OtherImages] = NULL

# we here only select the list at day 7 (slide 8)

Pyelonephritis_InfectionSubslidesD5 <-
    subset (Pyelonephritis_Infection, orig.ident == "PyeloD7_1")
Pyelonephritis_InfectionSubslidesD5
  # there seems to be an error in the susetting, so we removed other igmages
  #names(Pyelonephritis_InfectionSubslides@images)
SelectedImageName <- names(Pyelonephritis_InfectionSubslidesD5@images)[5]
 
  OtherImages <- Allimagmes[Allimagmes != SelectedImageName]
  
Pyelonephritis_InfectionSubslidesD5@images[OtherImages] = NULL

#nrow(Pyelonephritis_InfectionSubslidesD5@meta.data )
SpatialDimPlot(Pyelonephritis_InfectionSubslidesD5)

# the prediction of the object

Pyelonephritis_InfectionSubslidesD5[["predictions"]]
InfectedMat_D7<- t(Pyelonephritis_InfectionSubslidesD5[["predictions"]]@data)
InfectedMat_D7
# for final celltype matrix: 
InfectedMat_D7CellType<- InfectedMat_D7[,!colnames(InfectedMat_D7) %in% c("max")]

# correlation
plotCorrelationMatrix(InfectedMat_D7CellType)
plotInteractions(InfectedMat_D7CellType, "heatmap")

# scatterpie plot
# 
ct <- colnames(InfectedMat_D7CellType)
ct
# we did not add the low proportion in the scatterpie
InfectedMat_D7CellType[InfectedMat_D7CellType < 0.1] <- 0
# paletteMartin <- c(
#     "#000000", "#004949", "#009292", "#ff6db6", "#ffb6db", 
#     "#490092", "#006ddb", "#b66dff", "#6db6ff", "#b6dbff", 
#     "#920000", "#924900", "#db6d00", "#24ff24", "#ffff6d")

paletteMartin <- c(
    "#b6dbff", # HeaPT-S1
    "#99CCFF", # HeaPT-S2
    "#0099FF", # HeaPT-S3
    "#6699FF", # HeaPT-S4
    "#006ddb", # HeaPT-S5
    "#66CC99", # DegPT
    "#EE4E34", # MalaPT
    "#F5DEB3", # infiPT
    "#BEE5BF", # HybridPT
    "#FFD700", # CNT
    "#bdbdbd", # DTL
    "#b66dff", #TAL
    "#FF9900", #DCT-TAL
    "#F96167", #IC
    "#CCF381", #PC
    "#ff6db6", #URO
    "#C5DECD", #ENO
    "#FFCC00", #FIB
    "#F4FEC1", #PL
    "#CCFF33", #ResIMM
    "#99FF66", # RecMAC
    "#A1E8CC", # M1-M2
    "#FF00FF", #NEU
    "#DFF3E3", # T
    "#E2D1F9", #B
    "#CC0033" #NK
  )
#DefaultAssay(Pyelonephritis_InfectionSubslidesD5) <- "Spatial"

pal <- colorRampPalette(paletteMartin)(length(ct))
names(pal) <- ct
#pal
rownames(Pyelonephritis_InfectionSubslidesD5)
colnames(Pyelonephritis_InfectionSubslidesD7)
str(Pyelonephritis_InfectionSubslidesD7)
#SPOTlight:::. extract_image(Pyelonephritis_Infection )
#rownames(Pyelonephritis_Infection)
plotSpatialScatterpie(
  x= Pyelonephritis_InfectionSubslidesD7,
  y= InfectedMat_D7CellType,
  cell_types = colnames(InfectedMat_D7CellType),
    img = TRUE,
    scatterpie_alpha = 1,
    pie_scale = 0.4) +
    scale_fill_manual(
        values = pal,
        breaks = names(pal))
# colnames(DeconvolutedMatrix)
# ncol(Pyelonephritis_Infection)
# nrow(DeconvolutedMatrix)

plotInteractions(InfectedMat_D7CellType, "network")

# we only focused on the specific clusters
Idents(Pyelonephritis_InfectionSubslidesD7)
```

# ###################################
# For interesting infection regions
# ####################################

# #######
# For interesting infection regions : for the abscess of the CorMed
# we generate pie plot for day7 under infection regions for the CorMed abscess regions
```{r}
setwd(InfCorMeddir)
Pyelonephritis_Infection$orig.ident
Pyelonephritis_InfectionSubslidesD7 <-
    subset (Pyelonephritis_Infection, orig.ident == "PyeloD7_1")
Pyelonephritis_InfectionSubslidesD7
  # there seems to be an error in the susetting, so we removed other igmages
  #names(Pyelonephritis_InfectionSubslides@images)
SelectedImageName <- names(Pyelonephritis_InfectionSubslidesD7@images)[5]
SelectedImageName
OtherImages <- Allimagmes[Allimagmes != SelectedImageName]
OtherImages
Pyelonephritis_InfectionSubslidesD7@images[OtherImages] = NULL

# for a specific regions and specific clusters
# get the coordate of these cluster
coords <- GetTissueCoordinates(Pyelonephritis_InfectionSubslidesD7)
coords
Pyelonephritis_InfectionSubslidesD7@meta.data %>% head()
summary(coords)
Pyelonephritis_InfectionSubslidesD7@images$slice8

# we select the regions for the cluster
D5Pevsubcluster <- subset (Pyelonephritis_InfectionSubslidesD7, slice8_imagerow > 140 | slice8_imagecol > 200, invert = TRUE)
D5Pevsubcluster <- subset (D5Pevsubcluster, idents = c("N13","N14","N15","N16","N17"))
InfectedCorMedRegionD5Spatial <-SpatialDimPlot(D5Pevsubcluster,crop = TRUE, label = FALSE)
InfectedCorMedRegionD5Spatial
ggsave("Spatial_infected_day7_SpatialDimplot.pdf",
      plot = InfectedCorMedRegionD5Spatial,
      height = 3,
      width = 4.5 )

Pyelonephritis_InfectionSubslidesD7@meta.data[,c("orig.ident","Annotation")]
## merge is way too troublesome, therefore
FinalIntergratedTableAbcess<- merge(D5Pevsubcluster@meta.data[,c("orig.ident","Annotation")], t(D5Pevsubcluster[["predictions"]]@data), all=TRUE, by="row.names") 
?Heatmap
col_fun <- circlize::colorRamp2(c(0, 0.01, 1), c("white", "blue", "red"))

# generate the mean value for each column
pdf(file = "Spatial_infected_day7_FinalIntergratedTableAbcessHeatmap.pdf", height = 4, width = 4)
FinalIntergratedTableAbcessForHeatmap <-FinalIntergratedTableAbcess %>% dplyr::select(-c("Row.names",'orig.ident',"max")) %>% group_by(Annotation) %>% summarise_all("mean") %>% remove_rownames %>% column_to_rownames(var="Annotation") %>% as.matrix()

FinalIntergratedTableAbcessHeatmap<-FinalIntergratedTableAbcessForHeatmap[,colSums(FinalIntergratedTableAbcessForHeatmap)>0] %>% Heatmap(show_row_dend=T, show_column_dend = F,column_names_rot = 45,name = "Mean",col= col_fun, border = T)  

print(FinalIntergratedTableAbcessHeatmap)
dev.off()
#FinalIntergratedTableAbcess %>% group_by(Annotation) %>% summarize(the_medians = median(as.numeric(value), na.rm = TRUE))
#colorRamp2(c(0, 0.2, 1), c("gray", "blue", "red"))
```


```{r}
# generate the spatial pie plot for this region
ct <- colnames(InfectedMat_D7CellType)
ct
# we did not add the low proportion in the scatterpie
InfectedMat_D7CellType[InfectedMat_D7CellType < 0.1] <- 0
# paletteMartin <- c(
#     "#000000", "#004949", "#009292", "#ff6db6", "#ffb6db", 
#     "#490092", "#006ddb", "#b66dff", "#6db6ff", "#b6dbff", 
#     "#920000", "#924900", "#db6d00", "#24ff24", "#ffff6d")

paletteMartin <- c(
    "#b6dbff", # HeaPT-S1
    "#99CCFF", # HeaPT-S2
    "#0099FF", # HeaPT-S3
    "#6699FF", # HeaPT-S4
    "#006ddb", # HeaPT-S5
    "#66CC99", # DegPT
    "#EE4E34", # MalaPT
    "#F5DEB3", # infiPT
    "#BEE5BF", # HybridPT
    "#FFD700", # CNT
    "#bdbdbd", # DTL
    "#b66dff", #TAL
    "#FF9900", #DCT-TAL
    "#F96167", #IC
    "#CCF381", #PC
    "#ff6db6", #URO
    "#C5DECD", #ENO
    "#FFCC00", #FIB
    "#F4FEC1", #PL
    "#CCFF33", #ResIMM
    "#99FF66", # RecMAC
    "#A1E8CC", # M1-M2
    "#FF00FF", #NEU
    "#DFF3E3", # T
    "#E2D1F9", #B
    "#CC0033" #NK
  )
#DefaultAssay(Pyelonephritis_InfectionSubslidesD7) <- "Spatial"

pal <- colorRampPalette(paletteMartin)(length(ct))
names(pal) <- ct
D5PevsubclusterCellTypeMatrix <-t(D5Pevsubcluster[["predictions"]]@data)

D5PevsubclusterCellTypeMatrixNoMax <- D5PevsubclusterCellTypeMatrix[,!colnames(D5PevsubclusterCellTypeMatrix) %in% c("max")]
D5PevsubclusterCellTypeMatrixNoMax
# generate the scatter pie plot
colnames(D5PevsubclusterCellTypeMatrixNoMax)
#D0subclusterCellTypeMatrixNoMax[D0subclusterCellTypeMatrixNoMax < 0.1] <- 0
InfectedCorMedRegionD5SpatialPie<- plotSpatialScatterpie(
  x= D5Pevsubcluster,
  y= D5PevsubclusterCellTypeMatrixNoMax,
  cell_types = colnames(D5PevsubclusterCellTypeMatrixNoMax),
    img = TRUE,
    scatterpie_alpha = 1,
    pie_scale = 0.7,axis ="v") +
    scale_fill_manual(
        values = pal,
        breaks = names(pal)) +
  coord_sf(xlim = c(150, 300), ylim = c(300, 450))
?plotSpatialScatterpie
ggsave("Spatial_infected_day7_SpatialCellType_Scatterpie.pdf",
      plot = InfectedCorMedRegionD5SpatialPie,
      height = 3,
      width = 4.5 )

# correlation
InfectedCorMedRegionD5SpatialPieCorrelationMatrix <- plotCorrelationMatrix(D5PevsubclusterCellTypeMatrixNoMax)
ggsave("Spatial_infected_day7_InfectedCorMedRegionD5SpatialPieCorrelationMatrix.pdf",
      plot = InfectedCorMedRegionD5SpatialPieCorrelationMatrix,
      height = 4.5,
      width = 4.5 )
# we only select the matrix that rowsum >0
D5PevsubclusterCellTypeMatrixNoMaxLarger<- D5PevsubclusterCellTypeMatrixNoMax[,colSums(D5PevsubclusterCellTypeMatrixNoMax[])>0]
InfectedPevRegionD1Interactions<- plotInteractions(D5PevsubclusterCellTypeMatrixNoMaxLarger, "heatmap") + scale_fill_gradientn(colors = c("blue", "white", "red"))
?plotInteractions
ggsave("Spatial_infected_day7_InfectedPevRegionD1Interactions.pdf",
      plot = InfectedPevRegionD1Interactions,
      height = 4.5,
      width = 4.5 )
# 
# Test<-D0subclusterCellTypeMatrixNoMax[rowSums(D0subclusterCellTypeMatrixNoMax[])>0,]
# Test2<-Test[colSums(Test[])>0,]
# Test2
# plotCorrelationMatrix(Test2)
# plotInteractions(Test2, "heatmap")

```




# we generate pie plot for day7 under infection regions for the CorMed abscess regions
```{r}
setwd(InfCPiedir)
Pyelonephritis_Infection$orig.ident
Pyelonephritis_InfectionSubslidesD7 <-
    subset (Pyelonephritis_Infection, orig.ident == "PyeloD7_1")
Pyelonephritis_InfectionSubslidesD7
  # there seems to be an error in the susetting, so we removed other igmages
  #names(Pyelonephritis_InfectionSubslides@images)
SelectedImageName <- names(Pyelonephritis_InfectionSubslidesD7@images)[5]
SelectedImageName
OtherImages <- Allimagmes[Allimagmes != SelectedImageName]
OtherImages
Pyelonephritis_InfectionSubslidesD7@images[OtherImages] = NULL
Pyelonephritis_InfectionSubslidesD7@meta.data %>% head()
# for a specific regions and specific clusters
# get the coordate of these cluster
coords <- GetTissueCoordinates(Pyelonephritis_InfectionSubslidesD7)
coords %>% head()
Pyelonephritis_InfectionSubslidesD7@meta.data %>% head()
summary(coords)
Pyelonephritis_InfectionSubslidesD7@images$slice8

# we select the regions for the cluster : , invert = TRUE
D5Pevsubcluster <- subset (Pyelonephritis_InfectionSubslidesD7, (slice8_imagerow >310 & slice8_imagerow <450 )  & (slice8_imagecol < 330 & slice8_imagecol> 220) )
D5Pevsubcluster <- subset (D5Pevsubcluster, idents = c("N8","N10","N11","N12","N15"))
InfectedCorMedRegionD5Spatial <-SpatialDimPlot(D5Pevsubcluster,label = TRUE)
InfectedCorMedRegionD5Spatial
ggsave("Spatial_infected_day7_SpatialDimplot.pdf",
      plot = InfectedCorMedRegionD5Spatial,
      height = 3,
      width = 4.5 )
```

# we generated a specific marker genes 
```{r}
library(magrittr)
library(dplyr)
#install.packages("remotes")
remotes::install_github("jbergenstrahle/STUtility",force = T)
library(STutility)
?
?FindAllMarkers
InfectedCorMedRegionD5Spatial
D5Pevsubcluster
DefaultAssay(D5Pevsubcluster) <- "integrated"
nbs_2.markers <- FindAllMarkers(D5Pevsubcluster,test.use ="MAST")
nbs_2.markers
??SubsetSTData
#nbs_2.markers$gene <- rownames(nbs_2.markers)

nbs_2.markers
#se.subset <- SubsetSTData(D5Pevsubcluster, expression = nbs_2 %in% c("N12", "N15"))
sorted.marks <- nbs_2.markers %>% group_by(cluster) %>% arrange(-avg_log2FC) %>% top_n(n = 10, wt = abs(avg_log2FC)) 
sorted.marks

# Here we only selected several marker genes: 
DotPlot(D5Pevsubcluster, features = sorted.marks$gene %>% unique()) +RotatedAxis()
#DoHeatmap(D5Pevsubcluster, features = sorted.marks$gene, group.colors = c("red", "lightgray"))

Pyelonephritis_InfectionSubslidesD7@meta.data[,c("orig.ident","Annotation")]
## merge is way too troublesome, therefore
FinalIntergratedTableAbcess<- merge(D5Pevsubcluster@meta.data[,c("orig.ident","Annotation")], t(D5Pevsubcluster[["predictions"]]@data), all=TRUE, by="row.names") 
?Heatmap
col_fun <- circlize::colorRamp2(c(0, 0.01, 1), c("white", "blue", "red"))

# generate the mean value for each column
pdf(file = "Spatial_infected_day7_FinalIntergratedTableAbcessHeatmap.pdf", height = 4, width = 4)
FinalIntergratedTableAbcessForHeatmap <-FinalIntergratedTableAbcess %>% dplyr::select(-c("Row.names",'orig.ident',"max")) %>% group_by(Annotation) %>% summarise_all("mean") %>% remove_rownames %>% column_to_rownames(var="Annotation") %>% as.matrix()

FinalIntergratedTableAbcessHeatmap<-FinalIntergratedTableAbcessForHeatmap[,colSums(FinalIntergratedTableAbcessForHeatmap)>0] %>% Heatmap(show_row_dend=T, show_column_dend = F,column_names_rot = 45,name = "Mean",col= col_fun, border = T)  

print(FinalIntergratedTableAbcessHeatmap)
dev.off()
#FinalIntergratedTableAbcess %>% group_by(Annotation) %>% summarize(the_medians = median(as.numeric(value), na.rm = TRUE))
#colorRamp2(c(0, 0.2, 1), c("gray", "blue", "red"))
```

# generate the spatial pie plot for this region
```{r}

# scatterpie plot
# 
ct <- colnames(InfectedMat_D7CellType)
ct
# we did not add the low proportion in the scatterpie
InfectedMat_D7CellType[InfectedMat_D7CellType < 0.1] <- 0
# paletteMartin <- c(
#     "#000000", "#004949", "#009292", "#ff6db6", "#ffb6db", 
#     "#490092", "#006ddb", "#b66dff", "#6db6ff", "#b6dbff", 
#     "#920000", "#924900", "#db6d00", "#24ff24", "#ffff6d")

paletteMartin <- c(
    "#b6dbff", # HeaPT-S1
    "#99CCFF", # HeaPT-S2
    "#0099FF", # HeaPT-S3
    "#6699FF", # HeaPT-S4
    "#006ddb", # HeaPT-S5
    "#66CC99", # DegPT
    "#EE4E34", # MalaPT
    "#F5DEB3", # infiPT
    "#BEE5BF", # HybridPT
    "#FFD700", # CNT
    "#bdbdbd", # DTL
    "#b66dff", #TAL
    "#FF9900", #DCT-TAL
    "#F96167", #IC
    "#CCF381", #PC
    "#ff6db6", #URO
    "#C5DECD", #ENO
    "#FFCC00", #FIB
    "#F4FEC1", #PL
    "#CCFF33", #ResIMM
    "#99FF66", # RecMAC
    "#A1E8CC", # M1-M2
    "#FF00FF", #NEU
    "#DFF3E3", # T
    "#E2D1F9", #B
    "#CC0033" #NK
  )
#DefaultAssay(Pyelonephritis_InfectionSubslidesD7) <- "Spatial"

pal <- colorRampPalette(paletteMartin)(length(ct))
names(pal) <- ct
#pal
D5PevsubclusterCellTypeMatrix <-t(D5Pevsubcluster[["predictions"]]@data)

D5PevsubclusterCellTypeMatrixNoMax <- D5PevsubclusterCellTypeMatrix[,!colnames(D5PevsubclusterCellTypeMatrix) %in% c("max")]
# generate the scatter pie plot
colnames(D5PevsubclusterCellTypeMatrixNoMax)
#D0subclusterCellTypeMatrixNoMax[D0subclusterCellTypeMatrixNoMax < 0.1] <- 0
InfectedCorMedRegionD5SpatialPie<- plotSpatialScatterpie(
  x= D5Pevsubcluster,
  y= D5PevsubclusterCellTypeMatrixNoMax,
  cell_types = colnames(D5PevsubclusterCellTypeMatrixNoMax),
    img = TRUE,
    scatterpie_alpha = 1,
    pie_scale = 0.7,axis ="v") +
    scale_fill_manual(
        values = pal,
        breaks = names(pal)) +
  coord_sf(xlim = c(150, 300), ylim = c(300, 450))
?plotSpatialScatterpie
ggsave("Spatial_infected_day7_SpatialCellType_Scatterpie.pdf",
      plot = InfectedCorMedRegionD5SpatialPie,
      height = 3,
      width = 4.5 )

# correlation
InfectedCorMedRegionD5SpatialPieCorrelationMatrix <- plotCorrelationMatrix(D5PevsubclusterCellTypeMatrixNoMax)
ggsave("Spatial_infected_day7_InfectedCorMedRegionD5SpatialPieCorrelationMatrix.pdf",
      plot = InfectedCorMedRegionD5SpatialPieCorrelationMatrix,
      height = 4.5,
      width = 4.5 )
# we only select the matrix that rowsum >0
D5PevsubclusterCellTypeMatrixNoMaxLarger<- D5PevsubclusterCellTypeMatrixNoMax[,colSums(D5PevsubclusterCellTypeMatrixNoMax[])>0]
InfectedPevRegionD1Interactions<- plotInteractions(D5PevsubclusterCellTypeMatrixNoMaxLarger, "heatmap") + scale_fill_gradientn(colors = c("blue", "white", "red"))
?plotInteractions
ggsave("Spatial_infected_day7_InfectedPevRegionD1Interactions.pdf",
      plot = InfectedPevRegionD1Interactions,
      height = 4.5,
      width = 4.5 )
# 
# Test<-D0subclusterCellTypeMatrixNoMax[rowSums(D0subclusterCellTypeMatrixNoMax[])>0,]
# Test2<-Test[colSums(Test[])>0,]
# Test2
# plotCorrelationMatrix(Test2)
# plotInteractions(Test2, "heatmap")

```





# ###############################################################
# unfinished section:
# ###############################################################



```{r}
SpatialDimPlot(Pyelonephritis_InfectionD0)

DefaultAssay(Pyelonephritis_Infection)  <- "SCT"
Pyelonephritis_InfectionInfection <- subset(Pyelonephritis_Infection, idents = c("10_1"))

Pyelonephritis_InfectionD0 <- subset(Pyelonephritis_Infection, orig.ident == c("PyeloD0_1"))
Pyelonephritis_InfectionD0
?Seurat::subset
DefaultAssay(Pyelonephritis_InfectionD0)  <- "Spatial"

SpatialDimPlot(Pyelonephritis_InfectionD0, images = "slice1")

# plot the 


InfectedMat_10_1<- t(Pyelonephritis_InfectionInfection[["predictions"]]@data)
# we only select the slide 7 from the predictionPyelonephritis_Infection
#InfectedMat[,!colnames(mat) %in% c("max")]
#subset(Pyelonephritis_Infection, subset = images == "slice1")
InfectedMat_10_1[,!colnames(mat) %in% c("max")]

plotCorrelationMatrix(InfectedMat_10_1[,!colnames(mat) %in% c("max")])
plotInteractions(InfectedMat_10_1[,!colnames(mat) %in% c("max")], "heatmap")

Pyelonephritis_InfectionInfection_5_1 <- subset(Pyelonephritis_Infection, idents = c("5_1"))

InfectedMat_5_1<- t(Pyelonephritis_InfectionInfection_5_1[["predictions"]]@data)
# we only select the slide 7 from the predictionPyelonephritis_Infection
#InfectedMat[,!colnames(mat) %in% c("max")]
#subset(Pyelonephritis_Infection, subset = images == "slice1")
plotCorrelationMatrix(InfectedMat_5_1[,!colnames(mat) %in% c("max")])
plotInteractions(InfectedMat_5_1[,!colnames(mat) %in% c("max")], "heatmap")

# decovonvoluted matrix
mat<- t(Pyelonephritis_Infection[["predictions"]]@data)

colnames(mat)
# remove the max 
DeconvolutedMatrix <- mat[,!colnames(mat) %in% c("max")]
plotCorrelationMatrix(DeconvolutedMatrix)

plotInteractions(DeconvolutedMatrix, "heatmap")
plotInteractions(DeconvolutedMatrix, "network")

GetTissueCoordinates(Pyelonephritis_Infection)
#Pyelonephritis_Infection
length(ct)
# Scatterpie


ct <- colnames(DeconvolutedMatrix)
ct
# we did not add the low proportion in the scatterpie
DeconvolutedMatrix[DeconvolutedMatrix < 0.1] <- 0
paletteMartin <- c(
    "#000000", "#004949", "#009292", "#ff6db6", "#ffb6db", 
    "#490092", "#006ddb", "#b66dff", "#6db6ff", "#b6dbff", 
    "#920000", "#924900", "#db6d00", "#24ff24", "#ffff6d")

DefaultAssay(Pyelonephritis_Infection) <- "Spatial"

pal <- colorRampPalette(paletteMartin)(length(ct))
names(pal) <- ct
#pal
rownames(Pyelonephritis_Infection)
colnames(Pyelonephritis_Infection)
str(Pyelonephritis_Infection)
#SPOTlight:::. extract_image(Pyelonephritis_Infection )

nrow(Pyelonephritis_Infection)
nrow(DeconvolutedMatrix)
#rownames(Pyelonephritis_Infection)
plotSpatialScatterpie(
  x= Pyelonephritis_Infection,
  y= DeconvolutedMatrix,
  cell_types = colnames(DeconvolutedMatrix),
    img = TRUE,
    scatterpie_alpha = 1,
    pie_scale = 0.4) +
    scale_fill_manual(
        values = pal,
        breaks = names(pal))
# colnames(DeconvolutedMatrix)
# ncol(Pyelonephritis_Infection)
# nrow(DeconvolutedMatrix)
```

 ```{r}
# GetAssayData(Pyelonephritis_Infection, assay = "SCT" )
# # scale the object into 0 to 1
# 
# library(magrittr)
# rownames(Pyelonephritis_Infection)
# rownames(Pyelonephritis_Infection) %>% seq()
# #rownames(Pyelonephritis_Infection[["SCT"]]) %>% seq()
# Pyelonephritis_Infection_scaledMatrix<- sapply(rownames(Pyelonephritis_Infection) %>% seq(),  
#        function (i) { 
#            scales::rescale(GetAssayData(Pyelonephritis_Infection, 
#                               assay = "predictions")[rownames(Pyelonephritis_Infection)[i],], to = c(0,1)) }
#   ) %>% t
# 
# Pyelonephritis_Infection_scaledMatrix[1:10,10:20]
# 
# # check expression ranges
# quantile(Pyelonephritis_Infection_scaledMatrix, c(0.01, 1))
# 
# # add gene names
# dimnames(Pyelonephritis_Infection_scaledMatrix)[[1]] <- rownames(Pyelonephritis_Infection)
# 
# # set new scaled matrix to the slt 
# Pyelonephritis_Infection <- SetAssayData(Pyelonephritis_Infection, slot = "scale.data", Pyelonephritis_Infection_scaledMatrix)
# 
# Pyelonephritis_Infection[["predictions"]]
# 
# ?SpatialFeaturePlot
```

```{r}
# create a list to store the objects of subslide
Pyelonephritis_InfectionSubslides <- list()

i=0
for (SubSlide in  AllIdentities) {
  i=i+1
  # select the subslide object
  Pyelonephritis_InfectionSubslides[[i]] <-
    subset (Pyelonephritis_Infection, orig.ident == SubSlide)

  # there seems to be an error in the susetting, so we removed other igmages
  #names(Pyelonephritis_InfectionSubslides@images)
  SelectedImageName <- names(Pyelonephritis_InfectionSubslides[[i]]@images)[i]
 # SelectedImageName
  OtherImages <- Allimagmes[Allimagmes != SelectedImageName]
  
  Pyelonephritis_InfectionSubslides[[i]]@images[OtherImages] = NULL
   
}

```



```{r}
# measure the different frequency of each cluster

######################################################################
# ### measure the proportion of each spots of cell types
### this stored in the matrix of Pyelonephritis.integrated[["predictions"]]@data
#################################################################
# DefaultAssay(Pyelonephritis_Infection) <-"predictions"
# the matrix for the predicted cell types and spot id
row.names(Pyelonephritis_Infection[["predictions"]]@data)

colnames(Pyelonephritis_Infection[["predictions"]]@data)

#Pyelonephritis.integrated[["predictions"]]@data[, ]
################
# the matrix for the cluster of the spot ID
Pyelonephritis_Infection@meta.data

# cluster ID Pyelonephritis.integrated$seurat_clusters

## merge the Pyelonephritis.integrated@meta.data and Pyelonephritis.integrated[["predictions"]]@data

t(Pyelonephritis_Infection[["predictions"]]@data)

Pyelonephritis_Infection@meta.data[c("AAACCGTTCGTCCAGG-1_1"),]
row.names(t(Pyelonephritis_Infection[["predictions"]]@data))
Pyelonephritis_Infection@meta.data %>% head()

Table1 <- Pyelonephritis_Infection@meta.data[,c("orig.ident","Annotation","ConditionGroup")]

## merge is way too troublesome, therefore
FinalIntergratedTable<- merge(Pyelonephritis_Infection@meta.data[,c("orig.ident","Annotation","ConditionGroup")], t(Pyelonephritis_Infection[["predictions"]]@data), all=TRUE, by="row.names")

FinalIntergratedTable
colnames(FinalIntergratedTable)

# cluster 5_1
FinalIntergratedTable %>% filter(Annotation == "5_1")%>% slice_head(n=10)
# cluster 10_1
FinalIntergratedTable %>% filter(Annotation == "10_1" ) %>% slice_head(n=20)
# cluster 5_0
FinalIntergratedTable %>% filter(Annotation == "5_0")%>% slice_head(n=10) 
#%>% dplyr::select("FIB","M1-M2" ,"END","NEU","RecMAC", "T", "HybridPT", "B","TAL","InfiPT","ResIMM")
# cluster 10_0
FinalIntergratedTable %>% filter(Annotation == "10_0" ) %>% slice_head(n=20)
```

# generare the deconvolution using RCTD
```{r}
library(spacexr)
# set up reference
ref <- readRDS(file = paste0(Scindir, "PIPSeq_ImmuneSub_Annotated_v0823.RDS"))
ref <- UpdateSeuratObject(ref)

ref@meta.data %>% head()
Idents(ref) <- "ImmuneSub"


# extract information to pass to the RCTD Reference function
counts <- as.data.frame(ref[["RNA"]]@counts)
counts[1:4,1:4]
cluster <- as.factor(ref$ImmuneSub)
names(cluster) <- colnames(ref)

nUMI <- ref$nCount_RNA

names(nUMI) <- colnames(ref)
reference <- spacexr::Reference(counts, cluster, nUMI)

str(reference)
# set up query with the RCTD function SpatialRNA
#Pyelonephritis_Infection<-readRDS(file = paste0(Spindir, "FinalAbcessClustersObj.rds"))

counts <- as.data.frame(Pyelonephritis_Infection[["Spatial"]]@counts)
counts[2,1:4]
coords <- GetTissueCoordinates(Pyelonephritis_Infection)
coords
colnames(coords) <- c("x", "y")
coords[is.na(colnames(coords))] <- NULL
#total counts per pixel is nUMI
query <- spacexr::SpatialRNA(coords, counts, colSums(counts))
str(query)

```

# Using the reference and query object, we annotate the dataset and add the cell type labels to the query Seurat object. RCTD parallelizes well, so multiple cores can be specified for faster performance.

```{r}
# Optional: spacexr runs faster with more cores, but you may need to adjust system environment settings
Sys.setenv("OPENBLAS_NUM_THREADS"=2)

RCTD <- spacexr::create.RCTD(query, reference, max_cores = 2)
RCTD <- spacexr::run.RCTD(RCTD, doublet_mode = "full")
slide.seq <- AddMetaData(slide.seq, metadata = RCTD@results$results_df)
# Next, plot the RCTD annotations. Because we ran RCTD in doublet mode, the algorithm assigns a first_type and second_type for each barcode or spot.

p1 <- SpatialDimPlot(slide.seq, group.by = "first_type")
p2 <- SpatialDimPlot(slide.seq, group.by = "second_type")
p1 | p2


```




# generate the scatterpie from the SPOTlight
```{r}
ct <- colnames(FinalIntergratedTable)

FinalIntergratedTable[FinalIntergratedTable <0.1] <-0
paletteMartin <- c(
    "#000000", "#004949", "#009292", "#ff6db6", "#ffb6db", 
    "#490092", "#006ddb", "#b66dff", "#6db6ff", "#b6dbff", 
    "#920000", "#924900", "#db6d00", "#24ff24", "#ffff6d")

pal <- colorRampPalette(paletteMartin)(length(ct))
names(pal) <- ct
library(SPOTlight)

plotSpatialScatterpie(
    x = Pyelonephritis_Infection,
    y = FinalIntergratedTable,
    cell_types = colnames(y),
    img = FALSE,
    scatterpie_alpha = 1,
    pie_scale = 0.4) +
    scale_fill_manual(
        values = pal,
        breaks = names(pal))

```


```{r}
##########################################################################################
# The heat map figure to show the different compostion within timepoints in the cluster spots
###########################################################################################
### We combined all the dataset without group by orig.ident and measure the different composition

ClusterAllCluster_Median<-FinalIntergratedTable %>% group_by(Annotation) %>% summarise(ProximaltubuleI=median(`Proximal tubule I`),  ProximaltubuleII=median(`Proximal tubule II`), ProximaltubuleIII=median(`Proximal tubule III`), ProximaltubuleIV= median(`Proximal tubule IV`), ProximaltubuleVI=median(`Proximal tubule VI`), Distaltubule=median(`Distal tubule`),  ThinlimbofLOH=median(`Thin limb of LOH`),Urothelium= median(`Urothelium`),   ThickascendinglimbofLOH=median(`Thick ascending limb of LOH`), 
 Intercalatedcells=median(`Intercalated cells`), Principalcells=median(`Principal cells`), 
                                                                                                        Fibroblast=median(`Fibroblast`), Endothelium=median(`Endothelium`), Myeloblast=median(`Myeloblast`), Tcells=median(`T cells`),  Bcells=median(`B cells`),  Plasmacytoiddendriticcells=median(`Plasmacytoid dendritic cells`),
                                                                                                           NKCells=median(`NK cells`),  .groups= 'drop') %>% as.data.frame()



ClusterAllCluster_Median

write.csv(ClusterAllCluster_Median, file = "ClusterAllCluster_Median.csv")

### we calculate the median value for each cluster and also based on the timepotins
### we used the median value to  scale the cell-type compositions within each niche. 
ClusterTimepointGroup_Median<-FinalIntergratedTable %>% group_by(orig.ident, Annotation) %>% summarise(ProximaltubuleI=median(`Proximal tubule I`),  ProximaltubuleII=median(`Proximal tubule II`), ProximaltubuleIII=median(`Proximal tubule III`), ProximaltubuleIV= median(`Proximal tubule IV`), ProximaltubuleVI=median(`Proximal tubule VI`), Distaltubule=median(`Distal tubule`),  ThinlimbofLOH=median(`Thin limb of LOH`), ThickascendinglimbofLOH=median(`Thick ascending limb of LOH`), 
 Intercalatedcells=median(`Intercalated cells`), Principalcells=median(`Principal cells`),  Urothelium= median(`Urothelium`),                                                                                                        Fibroblast=median(`Fibroblast`), Endothelium=median(`Endothelium`), Myeloblast=median(`Myeloblast`), Tcells=median(`T cells`),  Bcells=median(`B cells`),  Plasmacytoiddendriticcells=median(`Plasmacytoid dendritic cells`),
                                                                                                           NKCells=median(`NK cells`),  .groups= 'drop')  %>% as.data.frame()
ClusterTimepointGroup_Median
write.csv(ClusterTimepointGroup_Median, file = "ClusterTimepointGroup_Median.csv")

### draw the heatmap for these combined clusters

Combined_Median_tidy <- ClusterAllCluster_Median %>% mutate_at( vars(-Annotation),scale) %>% pivot_longer(cols = -c(Annotation), names_to = "Property", values_to = "Value") 
Combined_Median_tidy
names(Combined_Median_tidy)
### reorder the levels
Combined_Median_tidy$Property<- ordered(factor(Combined_Median_tidy$Property),
                                levels=c("ProximaltubuleI","ProximaltubuleII",
                                         "ProximaltubuleIII", "ProximaltubuleIV", 
                                         "ProximaltubuleVI","Principalcells", "Intercalatedcells",  "ThickascendinglimbofLOH", "ThinlimbofLOH",  "Urothelium","Distaltubule",  "Fibroblast", "Endothelium","Myeloblast" ,  "Tcells" ,"Bcells" , "NKCells"))

pdf("Combined_Median_tidy_Heatmap.pdf",height = 6, width = 8)
Combined_Median_tidyHeatmap<- na.omit(Combined_Median_tidy) %>% heatmap(Property, Annotation, Value, scale="row",cluster_rows = FALSE, cluster_columns = TRUE ,palette_value=circlize::colorRamp2(seq(-4, 4, length.out = 11), RColorBrewer::brewer.pal(11, "RdBu") ) )
Combined_Median_tidyHeatmap
dev.off()


## setting up the conditions 
Condition<- levels(ClusterTimepointGroup_Median$orig.ident)
## run the for liips to generate the heatmap figures

### generate multiple heatmap plots



#pdf("Combined_heatmaps_Seurat_0320.pdf", height = 4, width = 40)

## attention par() and layout() not work for ggplot and 
# par(mfrow=c(11,1))
## instead we should use grid.arrange()
## grid.arrange(plot1, plot2, ncol=2)
ClusterTimepointGroup_Median
## create a new empty list and new number
i=0
my_vect <- c()
for (Pdate in Condition){
  ### generate the transfered objects for each condition
  ### 
 i =i+1
  Pdate_Median_tidy<- ClusterTimepointGroup_Median %>% filter(orig.ident==Pdate)  %>% mutate_at(vars (-orig.ident, -Annotation),scale) %>% pivot_longer(cols = -c(orig.ident, Annotation), names_to = "Property", values_to ="Value") 
  
  ### change the levels of Property at each condition
  ### tranfer the ClusterTimepointGroup_Median into a tide "element-feature-independent variables"  data frame, where the independent variable
  ### similar function to melt, but this will transfer the objects
  levels(factor(Pdate_Median_tidy$Property))
  Pdate_Median_tidy$Property<- ordered(factor(Pdate_Median_tidy$Property), 
                                       levels=c("ProximaltubuleI","ProximaltubuleII",
                                         "ProximaltubuleIII", "ProximaltubuleIV", 
                                         "ProximaltubuleVI","Principalcells", "Intercalatedcells",  "ThickascendinglimbofLOH", "ThinlimbofLOH",  "Urothelium","Distaltubule",  "Fibroblast", "Endothelium","Myeloblast" ,  "Tcells" ,"Bcells" , "NKCells"))
  
  ## change the NA value to Zero
  #PyeloD0_1_Median_tidy$Value[is.nan(PyeloD0_1_Median_tidy$Value)]<-0
  # ignore the na.omit
  na.omit(Pdate_Median_tidy)
  
 pdf(paste0(Pdate,"_Median_tidyHeatmap.pdf"),height = 6, width = 8)
  #PyeloD3_1_Median_tidyHeatmap<- na.omit(PyeloD3_1_Median_tidy) %>% heatmap(Property, seurat_clusters, Value, scale="row",cluster_rows = FALSE, cluster_columns = TRUE ,palette_value = c( "#E6E6FA", "#FFFFFF","#F1948A")) 
  
 Pdate_Median_tidy
  Pdate_Median_tidyHeatmap<- na.omit(Pdate_Median_tidy) %>% heatmap(Property, Annotation, Value, scale="row",cluster_rows = FALSE, cluster_columns = FALSE ,palette_value=circlize::colorRamp2(seq(-4, 4, length.out = 11), RColorBrewer::brewer.pal(11, "RdBu") ) )
  
  #PyeloD3_1_Median_tidyHeatmap<- na.omit(PyeloD3_1_Median_tidy) %>% heatmap(Property, seurat_clusters, Value, scale="row",cluster_rows = FALSE, cluster_columns = FALSE , palette_value = c("blue","white","red"), color_legend_min=-4, color_legend_max=4)
  
  #my_vect<- append(my_vect,Pdate_Median_tidyHeatmap)
  #plots[[i]]<- Pdate_Median_tidyHeatmap
  print(Pdate_Median_tidyHeatmap)
  dev.off()
}


###############################################################################################
# spearman correlation of the celltype matrix 
###############################################################################################
ClusterTimepointGroup_Median

for (Pdate in Condition){
  ### generate the transfered objects for each condition
  ### 
  #i =i+1
  #Pdate=c("PyeloD0_1")
  Pdate_Median_tidy_matrix <-ClusterTimepointGroup_Median %>% filter(orig.ident==Pdate) %>% dplyr::select(-c('orig.ident','Annotation'))
  
  #Pdate_Median_tidy_matrix
  #Pdate_Median_tidy_matrix<- ClusterTimepointGroup_Median %>% filter(orig.ident==Pdate) 
  
  #%>% mutate_at(vars (-orig.ident, -seurat_clusters),scale) %>% pivot_longer(cols = -c(orig.ident, seurat_clusters), names_to = "Property", values_to ="Value") 
  
 
  Pdate_Median_tidy_matrix_cor<-cor(as.matrix(Pdate_Median_tidy_matrix),method = "spearman")
  
  ## replace the NA into zerro
  Pdate_Median_tidy_matrix_cor <- replace(Pdate_Median_tidy_matrix_cor, is.na(Pdate_Median_tidy_matrix_cor),0)
  
  #testRes = cor.mtest(BiomarkerExpCor, conf.level = 0.95)
  Pdate_Median_tidy_matrix_cor_melt = melt(Pdate_Median_tidy_matrix_cor)
  
  ## create a dataframe
  
  #Pdate_Median_tidy_matrix_cor_melt$name= rep(Pdate, length(Pdate_Median_tidy_matrix_cor_melt$Var1))
 
  ## merge different dataframe
  
  pdf(paste0(Pdate,"_Correlation_tidyHeatmap.pdf"),height = 6, width = 8)
  #pdf("BioMarkerExpCorrelation.pdf", width = 10, height =10)
  ## generate the coeffecient figure
  corrplot(Pdate_Median_tidy_matrix_cor, order = 'hclust', type='upper',tl.col = 'black', insig='blank',
           addCoef.col ='black', number.cex = 0.5, tl.cex= 0.7, tl.srt = 45, diag=FALSE,col = colorRampPalette(c("LightBlue","white","FireBrick"))(100))
  dev.off()
  
  ## other way to plot
  # Pdate_Median_tidy_matrix_cor = rcorr(as.matrix(Pdate_Median_tidy_matrix), type='spearman')
  # 
  # Pdate_Median_tidy_matrix_cor_melt = melt(Pdate_Median_tidy_matrix_cor$r)
  # 
  # 
  # pdf(paste0(Pdate,"_Correlation_tidyHeatmap.pdf"),height = 6, width = 8)
  # 
  # #txtsize <- par('din')[2] / 2
  # ggplot(Pdate_Median_tidy_matrix_cor_melt, aes(x=Var1, y=Var2, fill=value)) + geom_tile() + 
  #   theme(axis.text.x = element_text(angle=90, hjust=TRUE))
  # dev.off()
   #+
   # xlab("") + ylab("") + 
   # geom_text(label=Pdate_Median_tidy_matrix_cor_melt$label, size=txtsize) + 
   # geom_text(label=Pdate_Median_tidy_matrix_cor_melt$strike, size=txtsize * 4, color="red", alpha=0.4) 

 
}


```

# redefine the default assay by the SCT using the scale data
```{r}
Pyelonephritis_Infection[["LOL"]] <-
  CreateAssayObject(counts = GetAssayData(Pyelonephritis_Infection,
                                          assay =
                                            "SCT", slot = "data")) #Copy "SCT data" to "LOL counts" and "LOL data"
Pyelonephritis_Infection <-
  SetAssayData(
    Pyelonephritis_Infection,
    assay = "LOL",
    slot = "scale.data",
    new.data = GetAssayData(Pyelonephritis_Infection, assay =
                              "SCT",
                            slot =
                              "scale.data")
  )
gc() #"Copy "SCT scale.data" to "LOL scale.data"
DefaultAssay(Pyelonephritis_Infection) <- "LOL"
Pyelonephritis_Infection <-
  DietSeurat(
    Pyelonephritis_Infection,
    assays = "LOL",
    counts = T,
    data = T,
    scale.data = T
  )
Pyelonephritis_Infection <-
  RenameAssays(Pyelonephritis_Infection, LOL = 'SCT')
## set up default of FinalAbcessClustersObjSubSlides

DefaultAssay(Pyelonephritis_Infection) <- "SCT"
 # save the RDS of Pyelonephritis_Infection
 #Pyelonephritis_Infection
Pyelonephritis_Infection
 saveRDS(filename = "Pyelonephritis_Infection_WithCellType.RDS",Pyelonephritis_Infection)
```


