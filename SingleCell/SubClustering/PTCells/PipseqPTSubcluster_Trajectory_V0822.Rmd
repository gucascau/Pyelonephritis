---
title: "PipseqICPC_Psudotime_V0516"
author: "Xin Wang"
date: "2024-05-16"
description: IC PC subclusters analyses:
    - Psudotime of PT

output: html_document
---
# Loading the packages
```{r}
# check the session information
sessionInfo()
# 
# dir.create('~/.R')
# file.create('~/.R/Makevars')
# R.home()
# install.packages("Rcpp")
# install.packages("Rcpp", repos = "https://cloud.r-project.org/")
# # reinstall monocle 3
# if (!requireNamespace("BiocManager", quietly = TRUE))
# install.packages("BiocManager")
# 
# BiocManager::install(version = "3.18")
# 
# BiocManager::install(c('BiocGenerics', 'DelayedArray', 'DelayedMatrixStats',
#                        'limma', 'lme4', 'S4Vectors', 'SingleCellExperiment',
#                        'SummarizedExperiment', 'batchelor', 'HDF5Array',
#                        'terra', 'ggrastr'),force = TRUE )
# #install.packages("devtools")
# 
#library(Rcpp)
#BiocManager::install(version = "3.14")
# #install.packages("uwot")
#options(buildtools.check = function(action) TRUE )
#BiocManager::install("monocle",force = TRUE)


#remotes::install_version("Matrix", version = "1.6-1.1")
library("monocle3")

#BiocManager::install("monocle3",force = TRUE)
# #library("monocle3")
# #Sys.setenv(BPCELLS_DEBUG_INSTALL="true") 
# # donwload from the website
#devtools::install(pkg = "~/Downloads/monocle3")
# devtools::install_github('cole-trapnell-lab/leidenbase')
#devtools::install_github('cole-trapnell-lab/monocle3')
# #remotes::install_github("bnprks/BPCells")
# devtools::install_github('cole-trapnell-lab/monocle3', ref="develop")
# sessionInfo()
# install.packages("libhdf5")

library(dplyr)
#install.packages("Seurat")
#install.packages("SeuratObject")
library(Seurat)
library(patchwork)

#install.packages('devtools') #assuming it is not already installed

# install.packages("rlang")
# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
library(devtools)
#install_github('andreacirilloac/updateR')
# install.packages("sctransform")
# install.packages("ggthemes")
# loading the libarary
library(updateR)

library("sctransform")
library("ggthemes")
library(Seurat)

# BiocManager::install("limma")
# BiocManager::install("ComplexHeatmap")
# BiocManager::install("biomaRt")
# BiocManager::install("methrix")BiocManager::install("org.Hs.eg.db")
# devtools::install_github("saeyslab/nichenetr")
library(limma)
library(nichenetr)
library(tidyverse)
library(dplyr)

library(biomaRt)
library("data.table")


library(umap)
library(patchwork)
library(cowplot)
library(installr)

#install.packages("Matrix", repos = "http://cran.r-project.org")
### we used discre color palettes from ggsci

library("ggsci")
library("ggplot2")
library("gridExtra")

#options(buildtools.check = function(action) TRUE )
#devtools::install_url('https://cran.r-project.org/src/contrib/Archive/Matrix.utils/Matrix.utils_0.9.7.tar.gz')
#devtools::install_github('cole-trapnell-lab/monocle3')
#library(monocle3)

library(harmony)
library(Seurat)
#library(SeuratData)
library(tidyverse)

#library(BPCells)
library(ggplot2)
library("devtools")
library("AnnotationDbi")
library("org.Hs.eg.db")
#library(tibble)
#library(future)
library(here)
library(patchwork)
library(future)
library(monocle3)
#devtools::install_dev("remotes")
#remotes::install_github('chris-mcginnis-ucsf/DoubletFinder')
#remotes::install_github(repo ='chris-mcginnis-ucsf/DoubletFinder' )
#install.packages("DoubletFinder")
library(DoubletFinder)
library(future.callr)
library(ComplexHeatmap)

library(RColorBrewer)
library(circlize)
library(monocle3)
#install.packages("magick")
library(magick)
# BiocManager::install(c('BiocGenerics', 'DelayedArray', 'DelayedMatrixStats',
#                        'limma', 'lme4', 'S4Vectors', 'SingleCellExperiment',
#                        'SummarizedExperiment', 'batchelor', 'HDF5Array',
#                        'terra', 'ggrastr'))
# install.packages("devtools")
# devtools::install_github('cole-trapnell-lab/monocle3')
# 
# if (!requireNamespace("BiocManager", quietly = TRUE))
# install.packages("BiocManager")
# BiocManager::install(version = "3.14")
#K means with 6 groups

# # some proiblem: 
# remove.packages("Matrix")
# remove.packages("irlba")
# install.packages("Matrix",type="source", dependencies=T)
# install.packages("irlba",type="source", dependencies=T)

```


## Step 2: Set up the workspace environment:
```{r}
rm(list=ls())
setwd("/Users/XXW004/Documents/Projects/RuizRosado/PIPseq/Results/Evaluation_V022723/CellEvaluation_Subclustering_V0803/PT_Subclusters/Pyseudotime/")
Indir <-c("/Users/XXW004/Documents/Projects/RuizRosado/PIPseq/Results/Evaluation_V022723/CellEvaluation_Subclustering_V0803/PT_Subclusters/")
Outdir <-c( "/Users/XXW004/Documents/Projects/RuizRosado/PIPseq/Results/Evaluation_V022723/CellEvaluation_Subclustering_V0803/PT_Subclusters/")
# setting up the seed 
set.seed(10000)
```


# read the PT object
```{r}
# Attention: the objected was generated by PipseqPTSubclusterDEG_Signaling_V0822.Rmd
# the 
PTcells <- readRDS(paste0(Indir,"PIPSeq_Annotated_OnlyPT_v0823.rds"))
DimPlot(PTcells)
```

# #####################################
## generate the Trajectories of PT cells
# #####################################
# 2.2 Prepared cds the object
```{r}
# build cds object
# remove.packages("Matrix")
# remove.packages("irlba") 
# install.packages("Matrix",type="source", dependencies=T)
# install.packages("irlba",type="source", dependencies=T)
#  traceback()
# devtools::load_all()
#install.packages('irlba')
#options(buildtools.check = function(action) TRUE )
#remotes::install_version("Matrix", version = "1.5-1")
# devtools::install_github('cole-trapnell-lab/monocle3')
# 
# remotes::install_version("Matrix", version = "1.6-1")
library(irlba)
library(Matrix)

#remotes::install_version("Matrix", version = "1.5-1")
## using the new way:
PTcells@meta.data%>% head()
table(PTcells@meta.data$DataSet)
gene_annotation = as.data.frame(rownames(PTcells@assays$RNA@counts))
colnames(gene_annotation) = "gene_short_name"
rownames(gene_annotation) = gene_annotation$gene_short_name


cds <- new_cell_data_set(
  PTcells@assays$RNA@counts,
  cell_metadata = PTcells@meta.data,
  gene_metadata = gene_annotation
  )

cds <- monocle3::preprocess_cds(cds, num_dim = 10)
cds@metadata
cds <- align_cds(cds, alignment_group = "DataSet")
#cds
cds <- reduce_dimension(cds,reduction_method = "UMAP" )
?reduce_dimension
plot_cells(cds, label_groups_by_cluster=FALSE)
 cds <- cluster_cells(cds)
 cds <- learn_graph(cds)
 cds <- order_cells(cds) # this step requires interactive selection for ordering the cells.
# 
# 
 cds <- as.CellDataSet(PTcells)
 plot_cells(cds)
 plot_cells(cds,
           color_cells_by = "DataSet",
           label_groups_by_cluster=TRUE,
           label_leaves=TRUE,
           label_branch_points=FALSE)
 
 plot_cells(cds,
           color_cells_by = "SCT_snn_res.0.3",
           label_groups_by_cluster=TRUE,
           label_leaves=TRUE,
           label_branch_points=FALSE)
# 
# 
# PTcells_expr_matrix[2,3]
# #PTcells_expr_matrix= LayerData(PTcells,assay="RNA",layer="counts")
# #PTcells_expr_matrix
# #PTcells_expr_matrix
# # Cell meta annotation
# p_data <- PTcells@meta.data 
# 
# Idents(PTcells)
# head(p_data)
# 
# PTcells_expr_matrix
# # Gene meta annotation
# f_data<- data.frame(gene_short_name = row.names(PTcells), row.names = row.names(PTcells))
# 
# p_data
# pre_cds <- new_cell_data_set(PTcells_expr_matrix,
#                          cell_metadata = p_data,
#                          gene_metadata = f_data)
# pData(pre_cds) %>% colnames()
# 
# cds <- preprocess_cds(pre_cds, num_dim = 100) #标准化+PCA降维
# ?preprocess_cds


```

# 2.2 Umap by Monocle3
```{r}
cds <- reduce_dimension(cds, preprocess_method = "PCA")
head(cds@int_colData$reducedDims$UMAP)

plot_cells(cds, reduction_method="UMAP", 
           show_trajectory_graph = FALSE,
           label_cell_groups = FALSE, 
           color_cells_by="SCT_snn_res.0.3")
#dev.off()
# UMAP by Seurat
seurat_umap <- Embeddings(PTcells, reduction = "umap")[colnames(cds),]
cds@int_colData$reducedDims$UMAP <- seurat_umap
head(cds@int_colData$reducedDims$UMAP)
plot_cells(cds, reduction_method="UMAP", 
           show_trajectory_graph = FALSE,
           label_cell_groups = FALSE, 
           color_cells_by="SCT_snn_res.0.3")

```


# Draw the monocle state, this way is to set up the root by identifying the root principal points
```{r}
#分群(类似monocle的State)

cds <- cluster_cells(cds)

#预测轨迹
cds <- learn_graph(cds)
#交互式确定root节点，可以选择多个。我这里选择了一个
#cds <- order_cells(cds) 
# a helper function to identify the root principal points:
get_earliest_principal_node <- function(cds, time_bin="0DPI"){
  cell_ids <- which(colData(cds)[, "DataSet"] == time_bin)
  closest_vertex <-
  cds@principal_graph_aux[["UMAP"]]$pr_graph_cell_proj_closest_vertex
  closest_vertex <- as.matrix(closest_vertex[colnames(cds), ])
  root_pr_nodes <-
  igraph::V(principal_graph(cds)[["UMAP"]])$name[as.numeric(names
  (which.max(table(closest_vertex[cell_ids,]))))]
  
  root_pr_nodes
}
cds <- order_cells(cds, root_pr_nodes=get_earliest_principal_node(cds))


PTCells_pseudotime <-plot_cells(cds, color_cells_by = "pseudotime", 
           label_cell_groups = FALSE, 
           label_leaves = TRUE,  
           label_branch_points = FALSE,graph_label_size=1.5)
PTCells_pseudotime
ggsave(filename = "PTCells_pseudotime_MonocaCluster.pdf", plot = PTCells_pseudotime, width = 4, height = 3)

PTCells_pseudotime_Celltype <- plot_cells(cds, reduction_method="UMAP", 
           show_trajectory_graph = FALSE,
           label_cell_groups = FALSE, 
           color_cells_by="SCT_snn_res.0.3")
ggsave(filename = "PTCells_pseudotime_Celltype.pdf", plot = PTCells_pseudotime_Celltype, width = 5, height = 3)
PTCells_pseudotime_Celltype

```
# Draw the monocle state, this way is to set up the root by ourselves
```{r}
#分群(类似monocle的State)

cds <- cluster_cells(cds)

#预测轨迹
cds <- learn_graph(cds)
#交互式确定root节点，可以选择多个。我这里选择了一个
cds <- order_cells(cds) 

PT_pseudotime <-plot_cells(cds, color_cells_by = "pseudotime", 
           label_cell_groups = FALSE, 
           label_leaves = TRUE,  
           label_branch_points = FALSE)

ggsave(filename = "PT_pseudotime_MonocaCluster.pdf", plot = PT_pseudotime, width = 4, height = 3)


```


```{r}
# Determine the psedudotime related genes
Track_genes <- graph_test(cds, neighbor_graph="principal_graph")

write.csv(Track_genes, file = "PT_pseudotime_Track_gene.csv")
Track_genes %>% head()

```

# plot the expression of interesting genes during the PT pseudotime
```{r}

# re-order the tracked genes by the q value and morans I
Track_genes <- Track_genes[,c(5,2,3,4,1,6)] %>% 
  dplyr::arrange(desc(morans_I),q_value)

# Plot some interesting genes for the PT pseudotime : Top 2 genes, Napsa, Kap, Ttr, Igfbp7, Havcr1 and Prom1
KapTrack <- plot_genes_in_pseudotime(cds[Track_genes$gene_short_name[1],] , 
                         min_expr=0.5)
ggsave(filename = "PT_pseudotime_KapTrack.pdf", plot = KapTrack, width = 5, height = 3)
NapsaTrack <- plot_genes_in_pseudotime(cds[Track_genes$gene_short_name[2],] , 
                         min_expr=0.5)
ggsave(filename = "PT_pseudotime_NapsaTrack.pdf", plot = NapsaTrack, width = 5, height = 3)

TtrTrack <- plot_genes_in_pseudotime(cds["Ttr",] , 
                         min_expr=0.5)
ggsave(filename = "PT_pseudotime_TtrTrack.pdf", plot = TtrTrack, width = 5, height = 3)

Igfbp7Track <- plot_genes_in_pseudotime(cds["Igfbp7",] , 
                         min_expr=0.5)
ggsave(filename = "PT_pseudotime_Igfbp7Track.pdf", plot = Igfbp7Track, width = 5, height = 3)

Track_genes$gene_short_name[1:5]


Track_genes$gene_short_name[2]
Track_genes$gene_short_name[1]
Havcr1Track <- plot_genes_in_pseudotime(cds["Havcr1",] , 
                         min_expr=0.5)

ggsave(filename = "PT_pseudotime_Havcr1Track.pdf", plot = Havcr1Track, width = 5, height = 3)

# For the 
Prom1Track <- plot_genes_in_pseudotime(cds["Prom1",],min_expr=0.5 )
ggsave(filename = "PT_pseudotime_Prom1Track.pdf", plot = Prom1Track, width = 5, height = 3)

FeaturePlot(PTcells, features = "Havcr1")

# generate the pparg
ggsave(filename = "PT_pseudotime_Havcr1Track.pdf", plot = Havcr1Track, width = 5, height = 3)

# For the 
PpargTrack <- plot_genes_in_pseudotime(cds["Pparg",],min_expr=0.5 )
ggsave(filename = "PT_pseudotime_PpargTrack.pdf", plot =PpargTrack, width = 5, height = 3)

FeaturePlot(PTcells, features = "Havcr1")

```

# choose the top signifcant for visualization
```{r}
diff_pseudo_gene <- Track_genes %>% 
  dplyr::arrange(q_value) %>%
  # remove the genes with mitochondrion
  filter(!grepl('^mt-|Hbb-', gene_short_name)) %>%
  rownames() %>% head(40)

# we ignore the mitochondria genes



diff_pseudo_gene

# generate the heatmap for those genes

diff_pseudo_gene.matrix <- exprs(cds)[match(diff_pseudo_gene,rownames(rowData(cds))),order(pseudotime(cds))]

diff_pseudo_gene.matrix <- t(apply(diff_pseudo_gene.matrix,1,function(x){smooth.spline(x,df=3)$y}))
diff_pseudo_gene.matrix <- t(apply(diff_pseudo_gene.matrix,1,function(x){(x-mean(x))/sd(x)}))
rownames(diff_pseudo_gene.matrix) <- diff_pseudo_gene;

#pheatmap(diff_pseudo_gene.matrix)

# because the plot_pseudotime_heatmap no longer have, we used the complexheatmap to draw the figure
# Reference: https://github.com/cole-trapnell-lab/monocle-release/issues/295
pdf("PT_pseudotime_psudotimeGenes.pdf", height = 6, width = 8)
htkm <- Heatmap(
  diff_pseudo_gene.matrix,
  name    = "z-score",
  col     = colorRamp2(seq(from=-2,to=2,length=11),rev(brewer.pal(11, "Spectral"))),
  show_row_names  = TRUE,
  show_column_names = FALSE,
  row_names_gp  = gpar(fontsize = 6),
  km = 8,
  row_title_rot = 0,
  use_raster=TRUE,
  cluster_rows  = TRUE,
  cluster_row_slices = FALSE,
  cluster_columns   = FALSE)

print (htkm)
dev.off()
#ggsave(filename = "PT_pseudotime_psudotimeGenes.pdf", plot = htkm, width = 8, height = 6)


#Ward.D2 Hierarchical Clustering
pdf("PT_pseudotime_psudotimeGenes_Hierarchicalcluster.pdf", height = 4, width = 4.5)
hthc <- Heatmap(
  diff_pseudo_gene.matrix,
  name                         = "z-score",
  col                          = colorRamp2(seq(from=-2,to=2,length=11),rev(brewer.pal(11, "Spectral"))),
  show_row_names               = TRUE,
  show_column_names            = FALSE,
  row_names_gp                 = gpar(fontsize = 6),
  clustering_method_rows = "ward.D2",
  clustering_method_columns = "ward.D2",
  row_title_rot                = 0,
  use_raster= TRUE,
  cluster_rows                 = TRUE,
  cluster_row_slices           = FALSE,
  cluster_columns              = FALSE)

print(hthc)
dev.off()

cds["Havcr1",] %>% head()
# Generate the Dotplot for these genes
plot_genes_in_pseudotime(cds[c("Havcr1"),] , 
                         min_expr=0.5)

DotPlot(PTcells, features =diff_pseudo_gene ) +RotatedAxis()

DotPlot(PTcells, features =c("Spp1","Havcr1","Itgb1","Top2a",
                             "Prom1","Pdgfb","Defb1","Fn1","Ftl1","Clu","Col6a1","Apoe","Tlr4","Tlr2","Tlr5"), col.min = -0.5 ) +RotatedAxis()

FeaturePlot(PTcells, features = c("Lcn2","Defb1","Egf","Havcr1","Tlr4","Tlr2","Ftl1","Fth1","Nfrb1"))
# the following no longer have 

Track_genes
# p = plot_pseudotime_heatmap(cds[diff_pseudo_gene,], 
#                         num_clusters = 3,  # default 6
#                         return_heatmap=T)
# 

# We generate the feature plot and pseudotime plot
# For the 
PysedudotimeDir<- c("/Users/XXW004/Documents/Projects/RuizRosado/PIPseq/Results/Evaluation_V022723/CellEvaluation_Subclustering_V0803/PT_Subclusters/Pyseudotime/")

PysedotimeMarkers <- paste0(PysedudotimeDir, "Makers/")
dir.create(PysedotimeMarkers)
setwd(PysedotimeMarkers)
diff_pseudo_gene
PTcells@meta.data
for (i in diff_pseudo_gene){
  plottrack <- plot_genes_in_pseudotime(cds[i],min_expr=0.5 )
  ggsave(filename = paste0("PT_pseudotime_",i,".pdf"), plot = plottrack, width = 5, height = 3)
  plotfeature<-FeaturePlot(PTcells, features = i, split.by = "DataSet")
  ggsave(filename = paste0("PT_featureplot_",i,".pdf"), plot = plotfeature, width = 9, height = 3)

  
}



```






